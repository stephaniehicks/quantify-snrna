---
title: "single-nucleus analysis (mouse cortex)"
author: "Albert Kuo and Stephanie Hicks"
date: "9/8/2020"
output: 
  html_document:
    code_folding: "hide"
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exploratory Analysis

```{r}
suppressPackageStartupMessages({
  library(here)
  library(tidyverse)
  library(tictoc)
  library(scran)
  library(scater)
  library(BiocSingular)
  library(SingleCellExperiment)
})
```

```{r}
run_number = "all" # give run_number or "all" for all of them together
sce_ls = list()
sce_ls[["transcripts"]] = readRDS(here("mouse_cortex", "salmon_quants", "transcripts_pipeline", paste0("sce_", run_number, ".rds")))
sce_ls[["preandmrna"]] = readRDS(here("mouse_cortex", "salmon_quants", "preandmrna_pipeline", paste0("sce_", run_number, ".rds")))
sce_ls[["introncollapse"]] = readRDS(here("mouse_cortex", "salmon_quants", "introncollapse_pipeline", paste0("sce_", run_number, ".rds")))
sce_ls[["intronseparate"]] = readRDS(here("mouse_cortex", "salmon_quants", "intronseparate_pipeline", paste0("sce_", run_number, ".rds")))
```

### Quality control

Discard low-quality cells and convert from SummarizedExperiment to SingleCellExperiment. Done in `save-sce.R`.

### Mapping differences

#### Library size comparison

To generate and save these plots, run `libsize-plots.R`.

```{r}
# Get library sizes
lib_sizes_ls = list()
for(i in seq_along(sce_ls)){
  sce = sce_ls[[i]]
  pipeline = names(sce_ls)[i]
  
  lib_sizes_ls[[pipeline]] = colData(sce) %>%
    as_tibble() %>%
    mutate(cell_barcode = rownames(colData(sce)),
           pipeline = pipeline)
}

lib_sizes = bind_rows(lib_sizes_ls)

# Compute median label
summ = lib_sizes %>% 
  group_by(pipeline, cortex) %>% 
  summarize(median = median(lib_size))

# Plot library size comparison between pipelines
p = lib_sizes %>%
  ggplot(aes(x = factor(pipeline, levels = c("transcripts", "preandmrna", "introncollapse", "intronseparate")), y = lib_size)) +
  geom_boxplot() + 
  # geom_text(data = summ, aes(x = pipeline, y = median, 
                              # label = round(median, 0)), 
            # vjust = -0.5, size = 2.5) +
  facet_wrap(~ cortex) +
  labs(x = "Pipeline",
       y = "Library size") +
  theme_bw() +
  theme(axis.text = element_text(size = 8))
print(p)

# ggsave(file = here(paste0("./mouse_cortex/plots/lib_size_comparison.png")),
#        plot = p, width = 8, height = 5)
# saveRDS(p, here(paste0("./mouse_cortex/plots/lib_size_comparison.rds")))
```

#### By Gene Type

```{r}
# Calculate sums for different gene types
gene_sum_tb_ls = list()
for(i in seq_along(sce_ls)){
  pipeline_name = names(sce_ls)[i]
  sce = sce_ls[[i]]
  
  lib_size_tb = colData(sce) %>%
    as_tibble() %>%
    mutate(cell_barcode = colnames(sce))
  
  for(gene_type_name in unique(rowData(sce)$gene_type)){ 
    genes_in_type = rowData(sce)[rowData(sce)$gene_type == gene_type_name, "gene_id"]
    m = counts(sce)[genes_in_type, ]
    if(length(genes_in_type) > 1){
      lib_size_gene_type = colSums(m)
    } else {
      lib_size_gene_type = m
    }
    lib_size_tb = lib_size_tb %>% 
      mutate(!!gene_type_name := lib_size_gene_type)
  }
  gene_sum_tb_ls[[pipeline_name]] = lib_size_tb %>%
    mutate(pipeline = pipeline_name)
}
gene_sum_tb = bind_rows(gene_sum_tb_ls)
```

```{r}
# Plot
for(gene_type in c("protein_coding", "lincRNA", "antisense", "processed_pseudogene")){ # 4 with highest counts across all pipelines
  # Compute median label
  summ = gene_sum_tb %>%
    group_by(pipeline, cortex) %>%
    summarize(median = median(!!sym(gene_type)))
  
  p = gene_sum_tb %>%
    ggplot(aes(x = pipeline, y = !!sym(gene_type))) + 
    geom_boxplot() +
    # geom_label(data = summ, aes(x = pipeline, y = median, 
    #                             label = round(median, 0))) +
    labs(x = "Pipeline") +
    facet_wrap(~ cortex) +
    theme_bw()
  
  print(p)
}
```

```{r}
# pipeline = "preandmrna"
# sce = sce_ls[[pipeline]]
```

#### Binned by Overall Expression

```{r}
genes_rowsums_tb = tibble(gene = rownames(sce_ls[["transcripts"]]))
common_cells = Reduce(intersect, sapply(sce_ls, colnames)) # Cell names are different in every pipeline?
for(i in seq_along(sce_ls)){
  pipeline_name = names(sce_ls)[i]
  sce = sce_ls[[i]]
  m = counts(sce)
  genes_rowsums = rowSums(m)
  tmp_tb = tibble(gene = names(genes_rowsums),
                  !!pipeline_name := genes_rowsums)
  genes_rowsums_tb = genes_rowsums_tb %>%
    left_join(., tmp_tb, by = "gene")
}

# Calculate overall expression and increase
genes_rowsums_tb = genes_rowsums_tb %>%
  mutate(mean_exp = rowMeans(select(genes_rowsums_tb, c("transcripts", "preandmrna", "introncollapse", "intronseparate")), na.rm = T),
         preandmrna_percent_inc = (preandmrna - transcripts)/transcripts)

# Median % increase in each bin
genes_rowsums_tb = genes_rowsums_tb %>%
  mutate(bin = ntile(mean_exp, 10))
genes_rowsums_tb %>%
  group_by(bin) %>%
  summarize(preandmrna_percent_inc_median = median(preandmrna_percent_inc, na.rm = T))

genes_rowsums_tb %>%
  ggplot(aes(x = as.factor(bin), y = preandmrna_percent_inc)) + 
  geom_boxplot() +
  scale_y_log10() +
  theme_bw()
```

#### Binned by GC content

```{r}
library(EDASeq)

id = rownames(sce_ls[["preandmrna"]])[1:5]
id = sub("\\..*", "", id)
org = "mmusculus_gene_ensembl"
tic()
getGeneLengthAndGCContent(id, org, mode=c("biomart"))
toc()
```


### Gene length bias 

#### Overall length bias

This may have an effect on cell type classification (if marker genes have different lengths). For DE, we fix the gene so a constant length bias for all cell groups should not affect the analysis. 

```{r} 
genes_rowsums_tb = tibble(gene = rownames(sce_ls[["transcripts"]]))
common_cells = Reduce(intersect, sapply(sce_ls, colnames)) 
for(i in seq_along(sce_ls)){
  pipeline_name = names(sce_ls)[i]
  sce = sce_ls[[i]]
  m = counts(sce)
  genes_rowsums = rowSums(m)
  tmp_tb = tibble(gene = names(genes_rowsums),
                  !!pipeline_name := genes_rowsums)
  genes_rowsums_tb = genes_rowsums_tb %>%
    left_join(., tmp_tb, by = "gene")
}

# Calculate % increase
genes_rowsums_tb = genes_rowsums_tb %>%
  mutate(preandmrna_percent_inc = (preandmrna - transcripts)/transcripts)

# Bin by length
genes_length_tb = rowData(sce_ls[["transcripts"]]) %>%
  as_tibble() %>%
  select(start, end, transcript_length) %>%
  mutate(length = end - start,
         gene = rownames(rowData(sce_ls[["transcripts"]]))) %>%
  select(gene, length, transcript_length)

genes_rowsums_tb = genes_rowsums_tb %>%
  left_join(genes_length_tb, by = "gene")
  
# Median % increase in each bin
genes_rowsums_tb = genes_rowsums_tb %>%
  mutate(bin = ntile(length, 10)) %>%
  mutate(bin_transcript = ntile(transcript_length, 10))

genes_rowsums_tb %>%
  group_by(bin) %>%
  summarize(preandmrna_percent_inc_median = median(preandmrna_percent_inc, na.rm = T))

# % Increase in reads
genes_rowsums_tb %>%
  ggplot(aes(x = as.factor(bin), y = preandmrna_percent_inc)) + 
  geom_boxplot() +
  scale_y_log10() +
  labs(x = "Bin (by gene length)") +
  theme_bw()

# Transcripts gene rowsum
genes_rowsums_tb %>%
  filter(!is.na(transcripts) & !is.na(preandmrna)) %>%
  ggplot(aes(x = as.factor(bin), y = transcripts)) + 
  geom_boxplot() +
  scale_y_log10() +
  labs(x = "Bin (by gene length)") +
  theme_bw()

# Preandmrna gene rowsum
genes_rowsums_tb %>%
  filter(!is.na(transcripts) & !is.na(preandmrna)) %>%
  ggplot(aes(x = as.factor(bin), y = preandmrna)) + 
  geom_boxplot() +
  scale_y_log10() +
  labs(x = "Bin (by gene length)") +
  theme_bw()
```
```{r}
# Controlling for % intronic region
genes_rowsums_tb %>%
  ggplot(aes(x = length, y = 1-transcript_length/length)) + 
  geom_point(alpha = 0.1) + 
  scale_x_log10() + 
  scale_y_continuous(labels = scales::percent) +
  scale_y_log10() +
  labs(x = "Preandmrna length",
       y = "Intronic region (%)") +
  theme_bw()

genes_rowsums_tb = genes_rowsums_tb %>%
  mutate(intron_prop = 1 - transcript_length/length)

genes_rowsums_tb %>%
  ggplot(aes(x = intron_prop)) + 
  geom_histogram() + 
  theme_bw()

genes_rowsums_tb %>%
  ggplot(aes(x = intron_prop, y = preandmrna)) + 
  geom_point(alpha = 0.1) + 
  geom_smooth() +
  scale_y_log10() +
  theme_bw()

genes_rowsums_tb %>%
  select(length, intron_prop, preandmrna, transcripts) %>%
  pivot_longer(c("preandmrna", "transcripts"), names_to = "pipeline", values_to = "count") %>%
  filter(intron_prop > 0.49 & intron_prop < 0.51) %>%
  ggplot(aes(x = length, y = count, color = pipeline)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth() +
  scale_y_continuous(limits = c(0.1, 1*10^6)) +
  scale_x_log10() +
  scale_y_log10() + 
  labs(x = "preandmrna length") +
  theme_bw()
```



```{r} 
# Make plots for Figure
# Length bias of preandmrna vs transcripts pipeline
tmp = genes_rowsums_tb %>%
  select(transcripts, preandmrna, bin, bin_transcript) %>%
  pivot_longer(cols = c("transcripts", "preandmrna"),
               names_to = "pipeline",
               values_to = "count") 

# Plot lines with ribbon
p = tmp %>%
  group_by(bin, pipeline) %>%
  filter(count > 0) %>%
  summarize(boxplot = list(setNames(boxplot.stats(count)$stats,
                                    c('lower_whisker','lower_hinge','median','upper_hinge','upper_whisker')))) %>%
  unnest_wider(boxplot) %>%
  ungroup() %>%
  ggplot(aes(x = bin, y = median, color = pipeline, fill = pipeline)) + 
  geom_ribbon(aes(ymin = lower_hinge, ymax = upper_hinge), alpha = 0.1, linetype = "dashed") +
  geom_point() +
  geom_line() + 
  scale_y_log10() +
  scale_x_continuous(breaks = 1:10) +
  labs(x = "Bin (by preandmrna length)",
       y = "count") +
  theme_bw() +
  theme(legend.position = "top")
saveRDS(p, here("./mouse_cortex/plots/preandmrna_length_bias.rds"))

p = tmp %>%
  group_by(bin_transcript, pipeline) %>%
  filter(count > 0) %>%
  summarize(boxplot = list(setNames(boxplot.stats(count)$stats,
                                    c('lower_whisker','lower_hinge','median','upper_hinge','upper_whisker')))) %>%
  unnest_wider(boxplot) %>%
  ungroup() %>%
  ggplot(aes(x = bin_transcript, y = median, color = pipeline, fill = pipeline)) + 
  geom_ribbon(aes(ymin = lower_hinge, ymax = upper_hinge), alpha = 0.1, linetype = "dashed") +
  geom_point() +
  geom_line() + 
  scale_y_log10() +
  scale_x_continuous(breaks = 1:10) +
  labs(x = "Bin (by transcript length)",
       y = "count") +
  theme_bw() +
  theme(legend.position = "top")
saveRDS(p, here("./mouse_cortex/plots/transcript_length_bias.rds"))

# Plot boxplots
p = tmp %>%
  ggplot(aes(x = as.factor(bin), y = count, color = pipeline)) + 
  geom_boxplot(outlier.shape = NA) + 
  coord_cartesian(ylim = c(0.01, 1*10^5)) +
  scale_y_log10() +
  labs(x = "Bin (by preandmrna length)") + 
  theme_bw() +
  theme(legend.position = "top")
print(p)

p = tmp %>%
  ggplot(aes(x = as.factor(bin_transcript), y = count, color = pipeline)) + 
  geom_boxplot(outlier.shape = NA) + 
  coord_cartesian(ylim = c(0.01, 1*10^5)) +
  scale_y_log10() +
  labs(x = "Bin (by transcript length)") + 
  theme_bw() +
  theme(legend.position = "top")
print(p)
```


```{r} 
# Gene rowsum across the 3 intronic pipelines
tmp = genes_rowsums_tb %>%
  pivot_longer(cols = c("transcripts", "preandmrna", "introncollapse", "intronseparate"),
               names_to = "pipeline",
               values_to = "count") %>%
  mutate(pipeline = fct_relevel(pipeline, c("transcripts", "preandmrna", "introncollapse", "intronseparate"))) %>%
  filter(pipeline != "transcripts")

p = tmp %>%
  ggplot(aes(x = as.factor(bin), y = count, color = pipeline)) + 
  geom_boxplot(outlier.shape = NA) + 
  coord_cartesian(ylim = c(0.01, 1*10^5)) +
  scale_y_log10() + 
  labs(x = "Bin (by preandmrna length)") + 
  theme_bw() +
  theme(legend.position = "top")
print(p)
saveRDS(p, here("./mouse_cortex/plots/preandmrna_length_bias_pipelines.rds"))

p = tmp %>%
  ggplot(aes(x = as.factor(bin_transcript), y = count, color = pipeline)) + 
  geom_boxplot(outlier.shape = NA) + 
  coord_cartesian(ylim = c(0.1, 1*10^5)) +
  scale_y_log10() + 
  labs(x = "Bin (by transcript length)") + 
  theme_bw() +
  theme(legend.position = "top")
print(p)
saveRDS(p, here("./mouse_cortex/plots/transcripts_length_bias_pipelines.rds"))

# Transcript length vs gene length
p = genes_rowsums_tb %>%
  ggplot(aes(x = length, y = transcript_length)) + 
  geom_point(alpha = 0.05) + 
  scale_x_log10() + 
  scale_y_log10() +
  labs(x = "preandmrna length",
       y = "transcript length") +
  theme_bw() +
  theme(legend.position = "top")
print(p)
saveRDS(p, here("./mouse_cortex/plots/transcript_vs_preandmrna_length.rds"))

# Gene length by bin
# p = genes_rowsums_tb %>%
#   ggplot(aes(x = as.factor(bin), y = length)) +
#   scale_y_log10() +
#   geom_boxplot() +
#   labs(x = "Bin",
#        y = "Preandmrna length") + 
#   theme_bw()
# print(p)
# saveRDS(p, here("./mouse_cortex/plots/preandmrna_gene_length_bin.rds"))
# 
# p = genes_rowsums_tb %>%
#   ggplot(aes(x = as.factor(bin_transcript), y = transcript_length)) +
#   scale_y_log10() +
#   geom_boxplot() +
#   labs(x = "Bin",
#        y = "Transcript length") + 
#   theme_bw()
# print(p)
# saveRDS(p, here("./mouse_cortex/plots/transcript_gene_length_bin.rds"))
```

Correct gene length bias in preandmrna pipeline to transcripts pipeline.

```{r}
library(mgcv)
# GAM model to correct for gene length bias
model_tb = tibble(gene = genes_rowsums_tb$gene,         # gene names
                  t = log10(genes_rowsums_tb$length),   # gene lengths
                  m1 = genes_rowsums_tb$preandmrna,     # the expression you want to correct (e.g. nucleic expression)
                  m2 = genes_rowsums_tb$transcripts)    # the expected expression (e.g. whole-cell expression)
model_tb = model_tb %>%
  mutate(M = log2(m1/m2)) %>% # calculate log2-fold expression ratio for each gene
  filter(!is.na(M) & !is.infinite(M)) # remove missing or infinite ratios

# Fit GAM model
model = gam(M ~ s(t), family = gaussian(link = "identity"), data = model_tb)
model_tb$fitted = predict(model, newdata = model_tb)

# Calculate gene length corrected expression
model_tb = model_tb %>%
  mutate(m1_corrected = m1/(2^fitted))
```


```{r}
# Plot gene length (x) vs log2-fold ratio (y), along with GAM model fit (line)
model_tb %>%
ggplot(aes(x = t, y = M)) +
  geom_point(size = 0.1, alpha = 0.1) +
  geom_line(aes(y = fitted), color = "blue") +
  labs(x = "Log10(gene length)",
       y = "Log2-fold ratio") +
  theme_bw()
```


```{r}
# Compare gene length bias in original vs corrected vs expected expression
model_tb %>%
  pivot_longer(cols = c("m1", "m1_corrected", "m2")) %>%
  ggplot(aes(x = t, y = value, color = name)) +
  facet_wrap(~ name, nrow = 1) +
  geom_point(size = 0.1, alpha = 0.01) +
  geom_smooth() +
  scale_y_log10() +
  labs(x = "Log10(gene length)",
       y = "Expression") +
  theme_bw()
```

#### By cell type

```{r}
# Get rowmeans for every pipeline and cell type group
common_cells = Reduce(intersect, sapply(sce_ls, colnames)) 

ding_cell_types = unique(colData(sce_ls[[1]])$ding_labels)
ding_cell_types = ding_cell_types[!is.na(ding_cell_types)]

for(i in seq_along(sce_ls)){
  pipeline_name = names(sce_ls)[i]
  tmp_tb_ls = list()
  
  # Subset to cell type
  for(cell_type in ding_cell_types){
    sce = sce_ls[[i]]
    
    cells_ct = colData(sce) %>% 
      as.data.frame() %>% 
      filter(ding_labels == cell_type) %>% 
      rownames()
    cells_ct = intersect(cells_ct, common_cells)
    
    # Subset to cortex
    for(c in c("cortex1", "cortex2")){
      cortex_cells = colData(sce) %>% 
        as.data.frame() %>% 
        filter(cortex == c) %>%
        rownames()
      
      cells = intersect(cells_ct, cortex_cells)
      
      m = counts(sce[, cells])
      genes_rowmeans = rowMeans(m)
      tmp_tb_ls[[paste(cell_type, c)]] = tibble(gene = names(genes_rowmeans),
                                                !!pipeline_name := genes_rowmeans,
                                                cell_type = cell_type,
                                                cortex = c)
    }
  }
  tmp_tb = bind_rows(tmp_tb_ls)
  
  if(i == 1){
    genes_rowmeans_tb = tmp_tb
  } else {
    genes_rowmeans_tb = genes_rowmeans_tb %>%
      left_join(., tmp_tb, by = c("gene", "cell_type", "cortex"))
  }
}

# Bin by length
genes_length_tb = rowData(sce_ls[["transcripts"]]) %>%
  as_tibble() %>%
  select(start, end, transcript_length) %>%
  mutate(length = end - start,
         gene = rownames(rowData(sce_ls[["transcripts"]]))) %>%
  select(gene, length, transcript_length)

genes_rowmeans_tb = genes_rowmeans_tb %>%
  left_join(genes_length_tb, by = "gene")
```

```{r}
# Plot gene length bias by cell type/cortex
p = genes_rowmeans_tb %>%
  mutate(cell_group = case_when(cell_type %in% c("Excitatory neuron", "Inhibitory neuron") ~ 1,
                                cell_type %in% c("Endothelial", "Microglia") ~ 2,
                                TRUE ~ 3)) %>%
  # filter(preandmrna > 0) %>%
  # filter(preandmrna_max_nA == 0) %>%
  # filter(cell_type %in% c("Excitatory neuron", "Astrocyte")) %>%
  # filter(cortex == "cortex2") %>%
  ggplot(aes(x = length, y = preandmrna, color = cell_type)) +
  facet_wrap(cell_group ~ cortex) +
  # geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  labs(x = "Gene length", y = "Mean expression", color = "Cell Type") +
  theme_bw() 

print(p)
# saveRDS(p, here("./mouse_cortex/plots/gene_length_bias_ea_cortex2.rds"))

# Plot gene length bias by cortex/cell type
genes_rowmeans_tb %>%
  mutate(cell_group = case_when(cell_type %in% c("Excitatory neuron", "Inhibitory neuron") ~ 1,
                                cell_type %in% c("Endothelial", "Microglia") ~ 2,
                                TRUE ~ 3)) %>%
  # filter(preandmrna > 0) %>%
  # filter(preandmrna_max_nA == 0) %>%
  # filter(cell_type %in% c("Excitatory neuron", "Astrocyte")) %>%
  # filter(cortex == "cortex2") %>%
  ggplot(aes(x = length, y = preandmrna, color = cortex)) +
  facet_wrap(cell_type ~ .) +
  # geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  labs(x = "Gene length", y = "Mean expression", color = "Cell Type") +
  theme_bw() 
```

```{r}
# Get probability of expression per gene for every pipeline and cell type group
common_cells = Reduce(intersect, sapply(sce_ls, colnames)) 

ding_cell_types = unique(colData(sce_ls[[1]])$ding_labels)
ding_cell_types = ding_cell_types[!is.na(ding_cell_types)]

for(i in seq_along(sce_ls)){
  pipeline_name = names(sce_ls)[i]
  tmp_tb_ls = list()
  
  # Subset to cell type
  for(cell_type in ding_cell_types){
    sce = sce_ls[[i]]
    
    cells_ct = colData(sce) %>% 
      as.data.frame() %>% 
      filter(ding_labels == cell_type) %>% 
      rownames()
    cells_ct = intersect(cells_ct, common_cells)
    
    # Subset to cortex
    for(c in c("cortex1", "cortex2")){
      cortex_cells = colData(sce) %>% 
        as.data.frame() %>% 
        filter(cortex == c) %>%
        rownames()
      
      cells = intersect(cells_ct, cortex_cells)
      
      m = counts(sce[, cells])
      genes_rowprobs = rowMeans(m != 0) # For a given, what proportion of cells had nonzero expression
      tmp_tb_ls[[paste(cell_type, c)]] = tibble(gene = names(genes_rowprobs),
                                                !!pipeline_name := genes_rowprobs,
                                                cell_type = cell_type,
                                                cortex = c)
    }
  }
  tmp_tb = bind_rows(tmp_tb_ls)
  
  if(i == 1){
    genes_rowprobs_tb = tmp_tb
  } else {
    genes_rowprobs_tb = genes_rowprobs_tb %>%
      left_join(., tmp_tb, by = c("gene", "cell_type", "cortex"))
  }
}

# Bin by length
genes_length_tb = rowData(sce_ls[["transcripts"]]) %>%
  as_tibble() %>%
  select(start, end, transcript_length) %>%
  mutate(length = end - start,
         gene = rownames(rowData(sce_ls[["transcripts"]]))) %>%
  select(gene, length, transcript_length)

genes_rowprobs_tb = genes_rowprobs_tb %>%
  left_join(genes_length_tb, by = "gene")
```

```{r}
p = genes_rowprobs_tb %>%
  mutate(cell_group = case_when(cell_type %in% c("Excitatory neuron", "Inhibitory neuron") ~ 1,
                                cell_type %in% c("Endothelial", "Microglia") ~ 2,
                                TRUE ~ 3)) %>%
  # filter(preandmrna > 0.9) %>%
  filter(cell_type %in% c("Excitatory neuron", "Astrocyte")) %>%
  filter(cortex == "cortex2") %>%
  ggplot(aes(x = length, y = preandmrna, color = cell_type)) +
  # facet_wrap(cell_group ~ .) +
  geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  # scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  labs(x = "Gene length", y = "Probability of expression", color = "Cell Type") +
  theme_bw() 

print(p)
```

##### For one cell

```{r}
genes_length_tb = rowData(sce_ls[["preandmrna"]]) %>%
  as_tibble() %>%
  select(start, end, transcript_length) %>%
  mutate(length = end - start,
         gene = rownames(rowData(sce_ls[["preandmrna"]]))) %>%
  select(gene, length, transcript_length)

m = counts(sce[, 1])
m = rowMeans(m)
tmp_tb = tibble(gene = names(m),
                preandmrna = m)

tmp_tb = tmp_tb %>% 
  inner_join(., genes_length_tb, by = "gene")
```


```{r}
tmp_tb %>%
  filter(preandmrna != 0) %>%
  ggplot(aes(x = length, y = preandmrna)) + 
  geom_point(alpha = 0.1) +
  # geom_smooth() + 
  scale_x_log10() +
  # scale_y_log10() +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = "Gene length", y = "Expression", title = "Removing Expression = 0") +
  theme_bw() 
```


##### Simulation 

```{r}
# Simulation on how differences in distribution of gene length between cell type contribute to cell-type specific gene length biases
set.seed(1)
n = 5000
gene_lengths = rnorm(n = n, mean = 10, sd = 2)
gene_lengths[gene_lengths < 0] = 0

epsilon = 0.01
sim = tibble(gene_id = 1:n,
             length = gene_lengths,
             neuron_bias = length,
             endothelial_bias = length*2,
             neuron_prob = dnorm(length, mean = 12, sd = 5),
             neuron_expression = rbinom(n = n, size = 1, prob = neuron_prob)*neuron_bias,
             endothelial_prob = dnorm(length, mean = 8, sd = 5),
             endothelial_expression = rbinom(n = n, size = 1, prob = endothelial_prob)*endothelial_bias)
```


```{r}
# Overall length bias 
sim %>%
  select(length, neuron_bias, endothelial_bias) %>%
  pivot_longer(-length, names_to = "cell_type", values_to = "expression") %>%
  ggplot(aes(x = length, y = expression, color = cell_type)) + 
  geom_point(alpha = 0.1) + 
  theme_bw()

# Cell type specific probability of expression
sim %>%
  ggplot() + 
  geom_line(aes(x = length, y = neuron_prob), color = "blue") + 
  geom_line(aes(x = length, y = endothelial_prob), color = "red") + 
  labs(y = "prob") +
  theme_bw()

# Cell type specific length bias
sim %>% 
  ggplot() +
  geom_point(aes(x = length, y = neuron_expression), alpha = 0.01, color = "blue") +
  geom_smooth(aes(x = length, y = neuron_expression), method = "loess", color = "blue") +
  geom_point(aes(x = length, y = endothelial_expression), alpha = 0.01, color = "red") +
  geom_smooth(aes(x = length, y = endothelial_expression), method = "loess", color = "red") +
  labs(y = "expression") +
  theme_bw()
```
Stochastic simulation

```{r}
set.seed(1)
n = 5000
seq_depth = 50
gene_lengths = 10^(rnorm(n = n, mean = 10, sd = 2))
gene_lengths[gene_lengths < 0] = 0

epsilon = 0.01
sim = tibble(gene_id = 1:n,
             length = gene_lengths,
             log10_length = log10(length),
             neuron_prob = dnorm(log10_length, mean = 12, sd = 5),
             endothelial_prob = dnorm(log10_length, mean = 8, sd = 5),
             neuron_bias = log10_length/max(2*log10(gene_lengths)),
             endothelial_bias = log10_length/(max(log10(gene_lengths))),
             neuron_expression = rbinom(n = n, size = seq_depth, prob = neuron_prob*neuron_bias),
             endothelial_expression = rbinom(n = n, size = seq_depth, prob = endothelial_prob*endothelial_bias))

# Apply downsampling
m = as.matrix(sim %>% select(neuron_expression, endothelial_expression))
lengths = sim$length
density_est = list()
density_est[["neuron_expression"]] = function(log10_length){return(dnorm(log10_length, mean = 12, sd = 5))}
density_est[["endothelial_expression"]] = function(log10_length){dnorm(log10_length, mean = 8, sd = 5)}

m_ds = downsample_by_density(m = m, density_est = density_est, lengths = lengths)
colnames(m_ds) = paste(colnames(m), "downsampled", sep = "_")
sim = cbind(sim, m_ds) %>%
  as_tibble()
```


```{r}
# Overall length bias 
sim %>%
  select(length, neuron_bias, endothelial_bias) %>%
  pivot_longer(-length, names_to = "cell_type", values_to = "expression") %>%
  ggplot(aes(x = length, y = expression, color = cell_type)) +
  geom_point(alpha = 0.5) + 
  scale_x_log10() +
  labs(title = "p'(L, C)") +
  theme_bw()

# Cell type specific probability of expression
sim %>%
  ggplot() + 
  geom_line(aes(x = length, y = neuron_prob), color = "blue") + 
  geom_line(aes(x = length, y = endothelial_prob), color = "red") + 
  scale_x_log10() +
  labs(y = "prob") +
  labs(title = "p(L, C)") +
  theme_bw()

# Cell type specific length bias
sim %>% 
  ggplot() +
  geom_point(aes(x = length, y = neuron_expression), alpha = 0.01, color = "blue") +
  geom_smooth(aes(x = length, y = neuron_expression), method = "loess", color = "blue") +
  geom_point(aes(x = length, y = endothelial_expression), alpha = 0.01, color = "red") +
  geom_smooth(aes(x = length, y = endothelial_expression), method = "loess", color = "red") +
  scale_x_log10() +
  labs(title = "Observed expression",
       y = "expression") +
  theme_bw()

# Downsampled expression
sim %>% 
  ggplot() +
  geom_point(aes(x = length, y = neuron_expression_downsampled), alpha = 0.01, color = "blue") +
  geom_smooth(aes(x = length, y = neuron_expression_downsampled), method = "loess", color = "blue") +
  geom_point(aes(x = length, y = endothelial_expression_downsampled), alpha = 0.01, color = "red") +
  geom_smooth(aes(x = length, y = endothelial_expression_downsampled), method = "loess", color = "red") +
  scale_x_log10() +
  labs(title = "Downsampled expression",
       subtitle = "Should only reflect the technial bias",
       y = "expression") +
  theme_bw()
```

#### GC content

```{r}
gc_content = readRDS(here("./mouse_cortex/output/gc_content.rds"))
gc_content = gc_content %>% 
  as_tibble(rownames = "gene") %>% 
  dplyr::rename(length_biomart = length)
genes_rowmeans_tb  = genes_rowmeans_tb %>%
  mutate(gene_noversion = gsub("\\..*", "", gene)) %>%
  left_join(., gc_content, by = c("gene_noversion" = "gene"))
```


```{r fig.width=10, fig.height=5}
# GC content
p = genes_rowmeans_tb %>%
  mutate(cell_group = case_when(cell_type %in% c("Excitatory neuron", "Inhibitory neuron") ~ 1,
                                cell_type %in% c("Endothelial", "Microglia") ~ 2,
                                TRUE ~ 3)) %>%
  # filter(preandmrna > 0) %>%
  # filter(preandmrna_max_nA == 0) %>%
  # filter(cell_type %in% c("Excitatory neuron", "Microglia", "Astrocyte")) %>%
  filter(cortex == "cortex1") %>%
  ggplot(aes(x = gc, y = preandmrna, color = cell_type)) +
  facet_wrap(cell_group ~ .) +
  # geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  labs(x = "GC content", y = "Mean expression", color = "Cell Type") +
  theme_bw() 

print(p)

# Length downloaded from Biomart
p = genes_rowmeans_tb %>%
  mutate(cell_group = case_when(cell_type %in% c("Excitatory neuron", "Inhibitory neuron") ~ 1,
                                cell_type %in% c("Endothelial", "Microglia") ~ 2,
                                TRUE ~ 3)) %>%
  # filter(preandmrna > 0) %>%
  # filter(preandmrna_max_nA == 0) %>%
  # filter(cell_type %in% c("Excitatory neuron", "Microglia", "Astrocyte")) %>%
  filter(cortex == "cortex1") %>%
  ggplot(aes(x = length_biomart, y = preandmrna, color = cell_type)) +
  facet_wrap(cell_group ~ .) +
  # geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  labs(x = "Gene length (from Biomart)", y = "Mean expression", color = "Cell Type") +
  theme_bw() 

print(p)
```

#### Sequence of As

Calculate number of A's with `count-a.R`. 

```{r}
n_string = "nA8"
transcripts_nA = readRDS(here("mouse_cortex", "salmon_files", paste0("transcripts_", n_string, ".rds")))
transcripts_nA = transcripts_nA %>%
  group_by(gene_id) %>%
  summarize(transcripts_max_nA = max(n))
transcripts_nA %>%
  ggplot(aes(x = transcripts_max_nA)) +
  geom_histogram() +
  # scale_x_log10() +
  theme_bw()

preandmrna_nA = readRDS(here("mouse_cortex", "salmon_files", paste0("preandmrna_", n_string, ".rds")))
preandmrna_nA = preandmrna_nA %>%
  group_by(gene_id) %>%
  summarize(preandmrna_max_nA = max(n))
preandmrna_nA %>%
  ggplot(aes(x = preandmrna_max_nA)) +
  geom_histogram() +
  # scale_x_log10() +
  theme_bw()
```

##### Overall length bias

```{r}
genes_rowsums_nA_tb = genes_rowsums_tb %>%
  left_join(., transcripts_nA, by = c("gene" = "gene_id")) %>%
  left_join(., preandmrna_nA, by = c("gene" = "gene_id"))
```

```{r}
# Number of A strings versus count
p = genes_rowsums_nA_tb %>%
  filter(preandmrna > 0) %>%
  ggplot(aes(x = length, y = preandmrna, color = preandmrna_max_nA == 0)) +
  geom_point(alpha = 0.01) +
  geom_smooth(method = "loess") +
  scale_x_log10() +
  scale_y_log10(limits = c(0.1, 1*10^6)) +
  labs(color = paste0(n_string, " == 0")) +
  theme_bw()
print(p)
saveRDS(p, here("./mouse_cortex/plots/nA8_preandmrna_length_bias_preandmrna.rds"))

p = genes_rowsums_nA_tb %>%
  filter(preandmrna > 0) %>%
  ggplot(aes(x = transcript_length, y = preandmrna, color = preandmrna_max_nA == 0)) +
  geom_point(alpha = 0.01) +
  geom_smooth(method = "loess") + 
  scale_x_log10() +
  scale_y_log10(limits = c(0.1, 1*10^6)) +
  labs(color = paste0(n_string, " == 0")) +
  # scale_y_continuous(limits = c(0, 10)) +
  theme_bw()
print(p)
saveRDS(p, here("./mouse_cortex/plots/nA8_transcript_length_bias_preandmrna.rds"))
```

```{r}
# Number of A strings versus count (transcripts pipeline)
p = genes_rowsums_nA_tb %>%
  # filter(introncollapse > 0) %>%
  ggplot(aes(x = length, y = transcripts, color = preandmrna_max_nA == 0)) +
  geom_point(alpha = 0.01) +
  geom_smooth(method = "loess") +
  scale_x_log10() +
  scale_y_log10(limits = c(0.1, 1*10^6)) +
  labs(color = paste0(n_string, " == 0")) +
  theme_bw()
print(p)
# saveRDS(p, here("./mouse_cortex/plots/nA12_preandmrna_length_bias_transcripts.rds"))

# p = genes_rowsums_nA_tb %>%
#   filter(transcripts > 0) %>%
#   ggplot(aes(x = transcript_length, y = transcripts, color = transcripts_max_nA == 0)) +
#   geom_point(alpha = 0.01) +
#   geom_smooth(method = "loess") + 
#   scale_x_log10() +
#   scale_y_log10(limits = c(0.1, 1*10^6)) +
#   labs(color = paste0(n_string, " == 0")) +
#   # scale_y_continuous(limits = c(0, 10)) +
#   theme_bw()
# print(p)
```


```{r}
# Calculate correlations
tmp = genes_rowsums_nA_tb %>%
  filter(preandmrna > 0)
cor(log10(tmp$preandmrna), log10(tmp$length))
cor(log10(tmp$preandmrna), log10(tmp$transcript_length))

tmp = genes_rowsums_nA_tb %>%
  filter(transcripts > 0)
cor(log10(tmp$transcripts), log10(tmp$length))
cor(log10(tmp$transcripts), log10(tmp$transcript_length))
```

```{r}
# Plots for correlations
p = genes_rowsums_nA_tb %>%
  filter(preandmrna > 0) %>%
  ggplot(aes(x = length, y = preandmrna)) +
  geom_point(alpha = 0.01) +
  scale_x_log10() +
  scale_y_log10(limits = c(0.1, 1*10^6)) +
  theme_bw()
print(p)
saveRDS(p, here("./mouse_cortex/plots/preandmrna_length_corr_preandmrna.rds"))

p = genes_rowsums_nA_tb %>%
  filter(preandmrna > 0) %>%
  ggplot(aes(x = transcript_length, y = preandmrna)) +
  geom_point(alpha = 0.01) +
  scale_x_log10() +
  scale_y_log10(limits = c(0.1, 1*10^6)) +
  theme_bw()
print(p)
saveRDS(p, here("./mouse_cortex/plots/transcript_length_corr_preandmrna.rds"))

p = genes_rowsums_nA_tb %>%
  filter(transcripts > 0) %>%
  ggplot(aes(x = length, y = transcripts)) +
  geom_point(alpha = 0.01) +
  scale_x_log10() +
  scale_y_log10(limits = c(0.1, 1*10^6)) +
  theme_bw()
print(p)
saveRDS(p, here("./mouse_cortex/plots/preandmrna_length_corr_transcripts.rds"))

p = genes_rowsums_nA_tb %>%
  filter(transcripts > 0) %>%
  ggplot(aes(x = transcript_length, y = transcripts)) +
  geom_point(alpha = 0.01) +
  scale_x_log10() +
  scale_y_log10(limits = c(0.1, 1*10^6)) +
  theme_bw()
print(p)
saveRDS(p, here("./mouse_cortex/plots/transcript_length_corr_transcripts.rds"))
```


##### By cell type

```{r}
genes_rowmeans_tb = genes_rowmeans_tb %>%
  left_join(., transcripts_nA, by = c("gene" = "gene_id")) %>%
  left_join(., preandmrna_nA, by = c("gene" = "gene_id"))
```

```{r}
genes_rowmeans_tb %>%
  mutate(cell_group = case_when(cell_type %in% c("Excitatory neuron", "Inhibitory neuron") ~ 1,
                                cell_type %in% c("Endothelial", "Microglia") ~ 2,
                                TRUE ~ 3)) %>%
  filter(preandmrna > 0) %>%
  filter(cell_type %in% c("Excitatory neuron", "Microglia", "Astrocyte") & cortex == "cortex1") %>%
  ggplot(aes(x = preandmrna_max_nA, y = preandmrna, color = cell_type)) +
  facet_wrap(cortex ~ cell_group, labeller = label_both) +
  geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  theme_bw()
```
```{r}
r2_bias = genes_rowmeans_tb %>%
  group_by(cell_type, cortex) %>%
  mutate(across(where(is.numeric), log10)) %>%
  mutate(across(where(is.numeric), ~na_if(., -Inf))) %>%
  mutate(across(where(is.numeric), ~na_if(., Inf))) %>%
  summarize(r2_transcripts_transcript_length = cor(transcripts, transcript_length, use = "pairwise.complete.obs")^2,
            r2_preandmrna_length = cor(preandmrna, length, use = "pairwise.complete.obs")^2,
            r2_transcripts_transcripts_max_nA = cor(transcripts, transcripts_max_nA, use = "pairwise.complete.obs")^2,
            r2_preandmrna_preandmrna_max_nA = cor(preandmrna, preandmrna_max_nA, use = "pairwise.complete.obs")^2) %>%
  pivot_longer(cols = starts_with("r2_"), names_to = "variables", values_to = "r2")

r2_bias %>%
  ggplot(aes(x = cell_type, y = r2)) +
  geom_point(aes(color = cortex)) +
  facet_wrap(~ variables, ncol = 2) +
  coord_flip() +
  theme_bw()
```

```{r}
# Relationship between nA8 under transcripts versus preandmrna pipeline
genes_rowmeans_tb %>%
  ggplot(aes(x = transcripts_max_nA, y = preandmrna_max_nA)) + 
  geom_point(alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1)+
  scale_x_log10() +
  scale_y_log10() +
  theme_bw()

# Relationship between gene length and nA8
genes_rowmeans_tb %>%
  ggplot(aes(x = preandmrna_max_nA, y = length)) + 
  geom_point(alpha = 0.5) +
  scale_x_log10() +
  scale_y_log10() +
  theme_bw()
```


#### By marker genes

Do different marker genes have different lengths?

```{r}
pred_celltypes = readRDS(here("mouse_cortex", "salmon_quants", "transcripts_pipeline", "singler_results.rds"))
all.markers <- metadata(pred_celltypes)$de.genes

# Subset to singleR labels that appear in (transcripts pipeline) data
celltype_markers = all.markers[unique(colData(sce_ls[[1]])$singleR_labels_pruned)]
celltype_markers = sapply(celltype_markers, unlist)
celltype_markers_tb_ls = list()
for(i in seq_along(celltype_markers)){
  if(is.null(unlist(celltype_markers[i]))) next
  celltype_markers_tb_ls[[i]] = tibble(cell_type = names(celltype_markers)[i],
                               gene_name = unique(unlist(celltype_markers[i])))
}
celltype_markers_tb = bind_rows(celltype_markers_tb_ls) 

celltype_markers_length_tb = rowData(sce_ls[["transcripts"]]) %>%
  as_tibble() %>%
  select(gene_name, start, end, transcript_length) %>%
  mutate(length = end - start,
         gene = rownames(rowData(sce_ls[["transcripts"]]))) %>%
  select(gene, gene_name, length, transcript_length) %>%
  right_join(., celltype_markers_tb, by = "gene_name")

# Plot gene length of marker genes by cell type
celltype_markers_length_tb %>%
  ggplot(aes(x = cell_type, y = length)) + 
  geom_boxplot() + 
  scale_y_log10() +
  coord_flip() +
  theme_bw()

celltype_markers_length_tb %>%
  ggplot(aes(x = cell_type, y = transcript_length)) + 
  geom_boxplot() + 
  scale_y_log10() +
  coord_flip() +
  theme_bw()
```


### PCA

PCA done in `save-sce.R`. To generate and save these plots, run `distribution-plots.R`.

```{r}
# PCA colored by provided attribute
plotReducedDim(sce_ls[["preandmrna"]], "PCA", colour_by = "singleR_labels_pruned", point_size = 1)
```

### HVG

https://osca.bioconductor.org/feature-selection.html

```{r fig.width=5, fig.height=5}
hvg_tb = tibble(gene = rownames(sce_ls[["transcripts"]]))

# Transcripts
for(i in seq_along(sce_ls)){
  pipeline = names(sce_ls)[i]
  sce = sce_ls[[i]]
  
  dec_mgv <- modelGeneVar(sce)
  
  # Visualizing the fit
  fit_mgv <- metadata(dec_mgv)
  # plot(fit_mgv$mean, fit_mgv$var, xlab="Mean of log-expression",
  #      ylab="Variance of log-expression")
  # curve(fit_mgv$trend(x), col="dodgerblue", add=TRUE, lwd=2)
  
  # Get list of HVGs
  tmp_tb = tibble(gene = rownames(dec_mgv),
                  !!pipeline := dec_mgv$p.value)
  
  hvg_tb = hvg_tb %>%
    left_join(., tmp_tb, by = "gene")
}


hvg_tb %>%
  # filter(transcripts < 0.5) %>%
  ggplot(aes(x = transcripts, y = preandmrna)) +
  geom_point(alpha = 0.5) +
  theme_bw() 
```

### Cell types 

Cell types added in `save-sce.R`.

#### singleR

Use singleR to map cells to cell type based on correlation in expression to mouse bulk RNA-seq data.

Vignettes:

* https://www.bioconductor.org/packages/release/bioc/vignettes/SingleR/inst/doc/SingleR.html
* https://bioconductor.org/packages/devel/data/experiment/vignettes/celldex/inst/doc/userguide.html#23_Mouse_RNA-seq

```{r}
library(pheatmap)

pred_celltypes = readRDS(here("mouse_cortex", "salmon_quants", "transcripts_pipeline", "singler_results.rds"))
all.markers <- metadata(pred_celltypes)$de.genes
# Built-in plots
# plotScoreHeatmap(pred_celltypes)
# features = unique(unlist(all.markers$qNSCs))
# features = tx2gene %>% filter(gene_name %in% features) %>% pull(gene_id) %>% unique()
# plotHeatmap(sce[, which(colData(sce)$ding_labels == "Astrocyte")], # Need to run ding section first
#             order_columns_by = "singleR_labels_pruned",
#             features = features,
#             fontsize_row = 1) # takes a while to run if too many cells/genes
```

```{r}
# PCA colored by singleR labels
plotReducedDim(sce, "PCA", colour_by = "singleR_labels_pruned")
```


#### Ding

> We used marker genes for each cell type to compute a score for each cell and automatically assign cell types to clusters.

Cell types added in `save-sce.R`.

```{r}
# PCA colored by Ding's labels
plotReducedDim(sce_ls[["preandmrna"]], "PCA", colour_by = "ding_labels")
```

#### Differences between pipelines

Some of these plots can be generated and saved by running `celltype-plots.R`. 

```{r}
# Get overlap with singleR labels
tb = as_tibble(colData(sce_ls[["preandmrna"]]))
overlap = table(tb$singleR_labels_pruned, tb$ding_labels, useNA = "ifany") %>%
  as.data.frame()

# Normalize frequency within each Ding cell type
overlap = overlap %>%
  group_by(Var2) %>%
  mutate(Freq_norm = Freq/sum(Freq)) %>%
  ungroup()

# Plot
overlap %>%
  ggplot(aes(x = Var1, y = Var2, fill = Freq)) + 
  scale_fill_gradient(low="white", high="blue") +
  geom_tile() +
  labs(x = "singleR_labels_pruned",
       y = "ding_labels") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

overlap %>%
  ggplot(aes(x = Var1, y = Var2, fill = Freq_norm)) + 
  scale_fill_gradient(low="white", high="blue") +
  geom_tile() +
  labs(x = "singleR_labels_pruned",
       y = "ding_labels") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
tb = as_tibble(preandmrna_cd) %>%
  mutate(cell = rownames(preandmrna_cd))

# Label cells where singleR label != ding label
tb = tb %>%
  mutate(ding_labels_match = case_when(ding_labels == "Astrocyte" ~ "Astrocytes",
                                       ding_labels == "Endothelial" ~ "Endothelial cells",
                                       ding_labels == "Excitatory neuron" ~ "Neurons",
                                       ding_labels == "Inhibitory neuron" ~ "Neurons",
                                       ding_labels == "Oligodendrocyte" ~ "Oligodendrocytes",
                                       T ~ ding_labels))

tb = tb %>%
  mutate(singleR_labels_match = case_when(singleR_labels_pruned == "Astrocytes activated" ~ "Astrocytes",
                                          singleR_labels_pruned == "Fibroblasts activated" ~ "Fibroblasts",
                                          singleR_labels_pruned == "Fibroblasts senescent" ~ "Fibroblasts",
                                          singleR_labels_pruned == "Macrophages activated" ~ "Macrophages",
                                          singleR_labels_pruned == "Microglia activated" ~ "Microglia",
                                          singleR_labels_pruned == "Neurons activated" ~ "Neurons",
                                          T ~ singleR_labels_pruned),
         non_matching_cells = (singleR_labels_match != ding_labels_match) | (is.na(singleR_labels_match) & !is.na(ding_labels_match)))

tb_misclassify = tb %>%
  filter(!is.na(ding_labels_match)) 

tb_misclassify %>%
  ggplot(aes(x = lib_size)) +
  geom_histogram(aes(fill = non_matching_cells)) +
  facet_wrap(~ ding_labels_match, nrow = 2, scales = "free") +
  labs(title = "preandmrna pipeline") +
  theme_bw()

print(sum(tb_misclassify$non_matching_cells, na.rm = T))

tb_misclassify
```

```{r}
# Counts for marker genes
astrocyte_mg = unique(unlist(all.markers$Astrocytes))
genes_in_type = t2g %>% filter(gene_name %in% astrocyte_mg) %>% pull(gene_id)
cd = colData(sce) %>% as_tibble() %>% mutate(cell = rownames(colData(sce)))
astrocyte_cells = cd %>% filter(ding_labels == "Astrocyte") %>% pull(cell)
astrocyte_matrix = counts(sce)[genes_in_type, astrocyte_cells] # Astrocyte cells and astrocyte marker genes only
# rowSums(astrocyte_matrix)
colSums(astrocyte_matrix) %>% 
  as_tibble() %>%
  mutate(cell = colnames(astrocyte_matrix)) %>%
  left_join(., cd, by = "cell") %>%
  ggplot(aes(x = value)) +
  geom_histogram(aes(fill = singleR_labels_pruned)) +
  theme_bw()
```

```{r}
# genes_in_type = names(sort(-rowSums(astrocyte_matrix))[3]) # Choose a specific gene
gene_type_name = "Astrocyte"
gene_sum_tb_ls = list()
for(i in seq_along(sce_ls)){
  pipeline_name = names(sce_ls)[i]
  sce_i = sce_ls[[i]]
  
  lib_size_tb = tibble(cell_barcode = astrocyte_cells)
  lib_size_gene_type = colSums(counts(sce_i)[intersect(rownames(counts(sce_i)), genes_in_type), astrocyte_cells, drop = F])
  lib_size_gene_type_tb = tibble(cell_barcode = names(lib_size_gene_type),
                                 !!gene_type_name := lib_size_gene_type)
  lib_size_tb = lib_size_tb %>% 
    left_join(., lib_size_gene_type_tb, by = "cell_barcode")
  gene_sum_tb_ls[[pipeline_name]] = lib_size_tb %>%
    pivot_longer(cols = -cell_barcode) %>%
    mutate(pipeline = pipeline_name)
}
gene_sum_tb = bind_rows(gene_sum_tb_ls)
gene_sum_tb = gene_sum_tb %>%
  pivot_wider(names_from = pipeline, values_from = value)
```

```{r}
# Plot comparison of marker genes for cell type across pipelines
gene_sum_tb %>%
  ggplot(aes(x = transcripts, y = preandmrna)) + 
  geom_point(size = 0.1, alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1) +
  facet_wrap(~ name, scales = "free") +
  labs(x = "num_reads_transcripts",
       y = "num_reads_preandmrna") +
  theme_bw()

# Boxplot
gene_sum_tb_2 = gene_sum_tb %>%
  pivot_longer(-c("cell_barcode", "name"), names_to = "pipeline", values_to = "counts")
summ <- gene_sum_tb_2 %>% 
  group_by(pipeline) %>% 
  summarize(median = median(counts))
gene_sum_tb_2 %>%
  ggplot(aes(x = pipeline, y = counts)) +
  geom_boxplot() +
  geom_label(data = summ, aes(x = pipeline, y = median, 
                              label = round(median, 0))) +
  theme_bw() 
```

```{r}
# Plot ratio of astrocyte:qNSC marker genes for astrocyte cells between pipelines
astrocyte_mg = unique(unlist(all.markers$Astrocytes))
astrocyte_genes = t2g %>% filter(gene_name %in% astrocyte_mg) %>% pull(gene_id)
qnsc_mg = unique(unlist(all.markers$qNSCs))
qnsc_genes = t2g %>% filter(gene_name %in% qnsc_mg) %>% pull(gene_id)

gene_type_name = "Astrocyte qNSC ratio"
gene_sum_tb_ls = list()
for(i in seq_along(sce_ls)){
  pipeline_name = names(sce_ls)[i]
  sce_i = sce_ls[[i]]
  
  lib_size_tb = tibble(cell_barcode = astrocyte_cells)
  lib_size_gene_type_astrocyte = colSums(counts(sce_i)[intersect(rownames(counts(sce_i)), astrocyte_genes), astrocyte_cells, drop = F])
  lib_size_gene_type_qnsc = colSums(counts(sce_i)[intersect(rownames(counts(sce_i)), qnsc_genes), astrocyte_cells, drop = F])
  lib_size_gene_type_tb = tibble(cell_barcode = names(lib_size_gene_type_astrocyte),
                                 !!gene_type_name := lib_size_gene_type_astrocyte/lib_size_gene_type_qnsc)
  lib_size_tb = lib_size_tb %>% 
    left_join(., lib_size_gene_type_tb, by = "cell_barcode")
  gene_sum_tb_ls[[pipeline_name]] = lib_size_tb %>%
    pivot_longer(cols = -cell_barcode) %>%
    mutate(pipeline = pipeline_name)
}
gene_sum_tb = bind_rows(gene_sum_tb_ls)
gene_sum_tb = gene_sum_tb %>%
  pivot_wider(names_from = pipeline, values_from = value)

# Plot comparison of marker genes for cell type across pipelines
gene_sum_tb %>%
  ggplot(aes(x = transcripts, y = preandmrna)) + 
  geom_point(size = 0.1, alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1) +
  facet_wrap(~ name, scales = "free") +
  labs(x = "num_reads_transcripts",
       y = "num_reads_preandmrna") +
  theme_bw()
```

```{r}
# Boxplot comparing ratios across pipelines
gene_sum_tb_2 = gene_sum_tb %>%
  pivot_longer(-c("cell_barcode", "name"), names_to = "pipeline", values_to = "ratio")
summ <- gene_sum_tb_2 %>% 
  left_join(., cd, by = c("cell_barcode" = "cell")) %>%
  group_by(pipeline) %>% 
  summarize(median = median(ratio))
gene_sum_tb_2 %>%
  left_join(., cd, by = c("cell_barcode" = "cell")) %>%
  ggplot(aes(x = pipeline, y = ratio)) +
  geom_boxplot() +
  geom_label(data = summ, aes(x = pipeline, y = median, 
                              label = round(median, 2))) +
  labs() +
  theme_bw() 
```

```{r}
# Boxplot comparing ratios across singleR_labels under a given pipeline
summ <- gene_sum_tb_2 %>% 
  filter(pipeline == !!pipeline) %>%
  left_join(., cd, by = c("cell_barcode" = "cell")) %>%
  group_by(singleR_labels_pruned) %>% 
  summarize(median = median(ratio))
gene_sum_tb_2 %>%
  filter(pipeline == !!pipeline) %>%
  left_join(., cd, by = c("cell_barcode" = "cell")) %>%
  ggplot(aes(x = singleR_labels_pruned, y = ratio)) +
  geom_boxplot() +
  geom_label(data = summ, aes(x = singleR_labels_pruned, y = median, 
                              label = round(median, 2))) +
  labs(title = pipeline,
       y = "Astrocyte:qNSC ratio") +
  theme_bw() 
```


```{r}
# Find genes that are most different between pipelines
gene_diff_tb_ls = list()
for(i in seq_along(sce_ls)){
  pipeline_name = names(sce_ls)[i]
  sce_i = sce_ls[[i]]
  gene_diff_tb_ls[[i]] = tibble(pipeline = pipeline_name,
                            gene_id = rownames(counts(sce_i)),
                            sum = rowSums(counts(sce_i)))
}

gene_diff_tb = bind_rows(gene_diff_tb_ls) %>%
  pivot_wider(names_from = pipeline, values_from = sum) %>%
  left_join(., t2g %>% select(gene_id, gene_name), by = "gene_id") %>% # Join to gene name
  mutate(diff = (preandmrna - transcripts)/preandmrna) %>%             # Calculate percent increase from transcripts to preandmrna
  arrange(-diff) %>%                                                   # Arrange by difference
  filter(complete.cases(.))                                            # Remove rows with NA (e.g. genes that are not present in all pipelines)


# Markers for all genes
all_marker_genes_tb_ls = list()
for(cell_type in names(all.markers)){
  all_marker_genes_tb_ls[[cell_type]] = tibble(cell_type = cell_type,
                                               gene_name = unique(unlist(all.markers[[cell_type]])))
}
all_marker_genes_tb = bind_rows(all_marker_genes_tb_ls)
gene_diff_plt = gene_diff_tb %>%
  left_join(., all_marker_genes_tb, by = "gene_name") %>%
  filter(complete.cases(.)) %>%     # Remove genes that are not marker genes
  mutate(group = ceiling((1:n())/1000)) # Assign group for every 1000 genes

# Summary statistics (median difference for each group)
gene_diff_plt %>% 
  group_by(group) %>%
  summarize(median_diff = median(diff)) %>%
  ungroup(group) %>%
  ggplot(aes(x = group, y = median_diff)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = 1:9) +
  theme_bw()
```

```{r fig.height = 10, fig.width = 8}
library(tidytext) # for reorder_within
# Plot distribution of marker genes for each group 
gene_diff_plt %>%
  group_by(cell_type, group) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  ggplot(aes(x = reorder_within(cell_type, -count, group), y = count)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~ group, scales = "free_x", labeller = label_both) +
  labs(x = "Cell type marker genes",
       title = "Distribution of marker genes grouped by difference between pipelines") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


gene_diff_plt %>%
  group_by(cell_type, group) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  ggplot(aes(x = group, y = count)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~ cell_type, scales = "free_x") +
  scale_x_continuous(breaks = 1:9) +
  labs(x = "Cell type marker genes",
       title = "Distribution of marker genes across the groups") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Plot lib size for different cell types
lib_size_tb = tibble(cell_barcode = colnames(sce_ls[[1]]),
                     ding_labels = colData(sce)$ding_labels)

for(i in seq_along(sce_ls)){
  pipeline_name = names(sce_ls)[i]
  sce_i = sce_ls[[i]]
  
  lib_size = colSums(counts(sce_i))
  lib_size_pipeline_tb = tibble(cell_barcode = colnames(sce_i),
                       !!paste0("lib_size_", pipeline_name) := lib_size)
  lib_size_tb = lib_size_tb %>%
    left_join(., lib_size_pipeline_tb, by = "cell_barcode")
}

lib_size_tb %>%
  ggplot(aes(x = lib_size_transcripts, y = lib_size_preandmrna, color = ding_labels), alpha = 0.5) + 
  facet_wrap(~ ding_labels) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  theme_bw()
```

### DE analysis

Here we compare if differential gene analysis differs between pipelines. 

In particular, I will look at the astrocytes versus excitatory neurons and identify genes that are differentially expressed in these two groups.

#### Remove biological length bias

We should model the gene expression as, for example, a binomial (or Poisson/NB). If the expression is Binomial(n, p), p is a mixture of 2 probabilities: p = p_BC*p_TC:
* p_BC = a biological cell-type specific gene length bias, e.g. the distribution of marker genes by length differs between cell types
* p_TC = a technical cell-type specific gene length bias

So to estimate p_TC, we need to somehow isolate it from p_BC:

1. Estimate p_BC as a function of gene length using the distribution of marker genes from singleR.
2. Then downsample the counts for a given gene according to p_BC. Resulting downsampled counts will have parameter p_TC.
3. Estimate the normalization factors in cQN using the downsampled counts. Use these normalization factors on the original counts.

```{r}
# estimate p_BC
pred_celltypes = readRDS(here("mouse_cortex", "salmon_quants", "transcripts_pipeline", "singler_results.rds"))
all.markers <- metadata(pred_celltypes)$de.genes

# Subset to singleR labels that appear in (preandmrna pipeline) data
celltype_markers = all.markers[unique(colData(sce_ls[["preandmrna"]])$singleR_labels_pruned)]
celltype_markers = sapply(celltype_markers, unlist)
celltype_markers_tb_ls = list()
for(i in seq_along(celltype_markers)){
  if(is.null(unlist(celltype_markers[i]))) next
  celltype_markers_tb_ls[[i]] = tibble(cell_type = names(celltype_markers)[i],
                                       gene_name = unique(unlist(celltype_markers[i])))
}
celltype_markers_tb = bind_rows(celltype_markers_tb_ls) 

celltype_markers_length_tb = rowData(sce_ls[["preandmrna"]]) %>%
  as_tibble() %>%
  select(gene_name, start, end, transcript_length) %>%
  mutate(length = end - start,
         gene = rownames(rowData(sce_ls[["preandmrna"]]))) %>%
  select(gene, gene_name, length, transcript_length) %>%
  right_join(., celltype_markers_tb, by = "gene_name")

# Plot density
density_neurons = density(log10(celltype_markers_length_tb %>% filter(cell_type == "Neurons") %>% pull(length)))
density_endothelial = density(log10(celltype_markers_length_tb %>% filter(cell_type == "Astrocytes") %>% pull(length)))
density_est = list("Excitatory neuron" = approxfun(density_neurons),
                   "Astrocyte" = approxfun(density_endothelial))

celltype_markers_length_tb %>%
  filter(cell_type %in% c("Neurons", "Astrocytes")) %>%
  ggplot(aes(x = length, fill = cell_type)) + 
  geom_density(alpha = 0.5) +
  # geom_histogram(position = "identity", alpha = 0.5) +
  scale_x_log10() +
  # coord_flip() +
  theme_bw()
```

#### cQN

```{r}
suppressPackageStartupMessages({
  library(cqn)
  library(scales)
  library(EDASeq)
})
```

Run on cluster using `cqn.sh`. 

```{r}
sce_sub = sce_ls[["preandmrna"]][, colData(sce_ls[["preandmrna"]])$ding_labels %in% c("Excitatory neuron", "Astrocyte") & colData(sce_ls[["preandmrna"]])$cortex == "cortex2"]

# Get gene lengths
genes_length_tb = rowData(sce_ls[["preandmrna"]]) %>%
  as_tibble() %>%
  select(start, end) %>%
  mutate(length = end - start,
         gene = rownames(rowData(sce_ls[["preandmrna"]]))) %>%
  select(gene, length)

# Get GC content
gc_content = readRDS(here("./mouse_cortex/output/gc_content.rds"))
gc_content = gc_content %>% 
  as_tibble(rownames = "gene") %>% 
  dplyr::rename(length_biomart = length)
genes_length_tb = genes_length_tb %>%
  mutate(gene_noversion = gsub("\\..*", "", gene)) %>%
  left_join(., gc_content, by = c("gene_noversion" = "gene"))
rownames(genes_length_tb) = genes_length_tb$gene

# Remove genes with missing GC content
keep_genes = which(!is.na(genes_length_tb$gc))
sce_sub = sce_sub[keep_genes, ]

genes_length_tb = genes_length_tb[keep_genes, ]
size_factors = colData(sce_sub)$sizeFactor

# Aggregate over cell types
counts_sub = as.matrix(round(counts(sce_sub)))
colnames(counts_sub) = colData(sce_sub)$ding_labels
counts_sub = t(rowsum(t(counts_sub), colnames(counts_sub)))

# Downsample according to density
counts_leftover = downsample_by_density(m = counts_sub, density_est = density_est, lengths = genes_length_tb$length)
```

```{r}
# Compare gene length bias before and after downsampling
compare_glb_tb = genes_length_tb %>%
  mutate(astrocyte_before = counts_sub[, 1],
    excitatory_neuron_before = counts_sub[, 2],
    astrocyte_after = counts_leftover[, 1],
    excitatory_neuron_after = counts_leftover[, 2]) %>%
  pivot_longer(cols = astrocyte_before:excitatory_neuron_after,
               names_to = "type",
               values_to = "count")

# Length vs expression
compare_glb_tb %>%
  ggplot(aes(x = length, y = count, color = type)) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() + 
  theme_bw()
```


```{r}
tic()
cqn_res = cqn(counts = counts_leftover,
              lengths = genes_length_tb$length, # length
              x = genes_length_tb$gc, # GC content
              # subindex = which(rowMeans(counts_sub) > 15), # Default is rowMeans > 50
              verbose = TRUE)
toc()
```

```{r}
dim(counts_sub) # original counts

# seq_cqn = readRDS(here("./mouse_cortex/output/counts_ea_preandmrna_cqn.rds")) # normalized counts
counts_normalized <- cqn_res$y + cqn_res$offset # log2 normalized expression values
rownames(counts_normalized) = rownames(sce_sub)
colnames(counts_normalized) = colnames(counts_sub)
pdata = as.data.frame(tibble(ding_labels = colnames(counts_sub)))
rownames(pdata) = colnames(counts_sub)
rownames(genes_length_tb) = genes_length_tb$gene
seq_cqn = newSeqExpressionSet(counts = 2^counts_normalized,
                              featureData = as.data.frame(genes_length_tb),
                              phenoData = pdata)

# Groups
grp1 = rownames(pData(seq_cqn))[pData(seq_cqn)$ding_labels == "Inhibitory neuron"]
grp2 = rownames(pData(seq_cqn))[pData(seq_cqn)$ding_labels == "Endothelial"]

# Compare
counts_sub_sweep = sweep(counts_sub, 2, colSums(counts_sub), `/`)           # divide by size factors
counts_sub_sweep = log2(counts_sub_sweep + 1)
M_std = rowMeans(counts_sub_sweep[, grp1, drop = FALSE]) - rowMeans(counts_sub_sweep[, grp2, drop = FALSE])
A_std = rowMeans(counts_sub_sweep)

counts_cqn_sweep = sweep(counts(seq_cqn), 2, colSums(counts(seq_cqn)), `/`) # divide by size factors
counts_cqn_sweep = log2(counts_cqn_sweep + 1)
M_cqn = rowMeans(counts_cqn_sweep[, grp1, drop = FALSE]) - rowMeans(counts_cqn_sweep[, grp2, drop = FALSE])
A_cqn = rowMeans(counts_cqn_sweep)

intersect_genes = intersect(names(M_std), names(M_cqn)) # Some genes did not have GC content and were not cqn-normalized
genes_length_tb = genes_length_tb %>%
  filter(gene %in% intersect_genes)

plot_dt = genes_length_tb %>%
  mutate(M_std = M_std[intersect_genes],
         A_std = A_std[intersect_genes],
         M_cqn = M_cqn[intersect_genes],
         A_cqn = A_cqn[intersect_genes]) %>%
  pivot_longer(M_std:A_cqn, names_to = c(".value", "data"), names_sep = "_")

whGenes = names(A_std)[A_std >= mean(A_std)]

# A versus gene length
plot_dt %>%
  filter(gene %in% whGenes) %>%
  mutate(length_label = ifelse(length > quantile(length, 0.9), "> 90th percentile", NA),
         length_label = ifelse(length < quantile(length, 0.1), "< 10th percentile", length_label)) %>%
  # filter(!is.na(length_label)) %>%
  ggplot(aes(x = length, y = A, color = length_label)) + 
  facet_wrap(~ data) +
  geom_point(alpha = 0.01) + 
  geom_smooth() +
  scale_x_log10() +
  # scale_y_log10() +
  ylim(c(-0.00005, 0.0015)) +
  theme_bw()

# M versus gene length
plot_dt %>%
  filter(gene %in% whGenes) %>%
  mutate(length_label = ifelse(length > quantile(length, 0.9), "> 90th percentile", NA),
         length_label = ifelse(length < quantile(length, 0.1), "< 10th percentile", length_label)) %>%
  # filter(!is.na(length_label)) %>%
  ggplot(aes(x = length, y = M, color = length_label)) + 
  facet_wrap(~ data) +
  geom_point(alpha = 0.1) + 
  geom_smooth() +
  scale_x_log10() +
  # scale_y_log10() +
  ylim(c(-0.005, 0.005)) +
  theme_bw()

plot_dt %>%
  filter(gene %in% whGenes) %>%
  mutate(length_label = ifelse(length > quantile(length, 0.9), "> 90th percentile", NA),
         length_label = ifelse(length < quantile(length, 0.1), "< 10th percentile", length_label)) %>%
  filter(!is.na(length_label)) %>%
  ggplot(aes(x = A, y = M, color = length_label)) +
  facet_wrap(~ data) +
  geom_point(alpha = 0.1) + 
  # scale_color_gradientn(colours = terrain.colors(10)) + 
  scale_x_log10() +
  # scale_y_log10() +
  # geom_smooth(se = FALSE) +
  guides(color = guide_legend(override.aes = list(alpha = 1))) +
  theme_bw()
```

#### DESeq 

Run `de-analysis.R` or `cqn.R` on cluster.

```{r}
library(DESeq2)
library(apeglm)

sce_sub = sce_ls[["preandmrna"]][, colData(sce_ls[["preandmrna"]])$ding_labels %in% c("Excitatory neuron", "Astrocyte")]

# Store counts and intermediate quantities (dds is a SummarizedExperiment)
dds = DESeqDataSetFromMatrix(countData = ceiling(counts(sce_sub)[1:10, ]), # take integers 
                             colData = colData(sce_sub),
                             design = ~ cortex + ding_labels)

# Compute log2fold change and p-values
tic()
dds = DESeq(dds) # this function estimates size factor, dispersion, then negative binomial GLM fitting and Wald statistics
toc()

res = results(dds)
res

# Shrinkage of LFC
resultsNames(dds)
resLFC = lfcShrink(dds, coef="ding_labels_Excitatory.neuron_vs_Astrocyte", type="apeglm")

# MA plot for shrunken log2 fold change
plotMA(resLFC)

# Add gene length to table
genes_length_tb = rowData(sce_ls[["preandmrna"]]) %>%
  as_tibble() %>%
  select(start, end) %>%
  mutate(length = end - start,
         gene = rownames(rowData(sce_ls[["preandmrna"]]))) %>%
  select(gene, length)

res = res %>%
  as_tibble() %>%
  mutate(gene = rownames(res)) %>%
  left_join(., genes_length_tb, by = "gene")
```


* The adjusted pvalue, `padj`, comes from the "BH" method of the p.adjust() function in the stats package. Sources: https://support.bioconductor.org/p/74097/, https://www.biostars.org/p/325750/ 
* deseq does "independent filtering" to filter out lowly expressed genes before calculating padj


```{r}
# pipeline = "transcripts"
# res_1 = readRDS(here(paste0("./mouse_cortex/output/de_ie_", pipeline, "_lfc.rds")))
# res_2 = readRDS(here(paste0("./mouse_cortex/output/de_ie_", pipeline, "_lfc_cqn.rds")))
# res_3 = readRDS(here(paste0("./mouse_cortex/output/de_ie_", pipeline, "_lfc_cqn_bc.rds")))

res_1 = readRDS(here(paste0("./mouse_cortex/output/de_ie_", "transcripts", "_lengthsforcepreandmrna_FALSE", "_lfc.rds")))
res_2 = readRDS(here(paste0("./mouse_cortex/output/de_ie_", "preandmrna", "_lfc.rds")))
res_3 = readRDS(here(paste0("./mouse_cortex/output/de_ie_", "introncollapse", "_lengthsforcepreandmrna_FALSE", "_lfc.rds")))
res_4 = readRDS(here(paste0("./mouse_cortex/output/de_ie_", "intronseparate", "_lengthsforcepreandmrna_FALSE", "_lfc.rds")))

# res = res %>%
  # left_join(., genes_rowsums_tb %>% distinct(gene, transcripts, preandmrna, introncollapse, intronseparate), by = "gene") # from binned by overall expression

label_res = function(res, pairwise = FALSE){
  # Label which genes are marker genes
  if(pairwise){ # Use pairwise differential genes only
    celltype_markers = all.markers[unique(colData(sce_ls[["preandmrna"]])$singleR_labels_pruned)]
    singler_marker_genes_1 = c(celltype_markers$Neurons$`Endothelial cells`, celltype_markers$`Neurons activated`$`Endothelial cells`)
    singler_marker_genes_2 = c(celltype_markers$`Endothelial cells`$Neurons, celltype_markers$`Endothelial cells`$`Neurons activated`)
    # singler_marker_genes_1 = c(celltype_markers$Neurons$`Astrocytes`, celltype_markers$Neurons$`Astrocytes activated`,
    #                            celltype_markers$`Neurons activated`$`Astrocytes`, celltype_markers$`Neurons activated`$`Astrocytes activated`)
    # singler_marker_genes_2 = c(celltype_markers$`Astrocytes`$Neurons, celltype_markers$`Astrocytes`$`Neurons activated`,
    #                            celltype_markers$`Astrocytes activated`$Neurons, celltype_markers$`Astrocytes`$`Neurons activated`)
    
    singler_marker_genes_1 = rowData(sce_ls[["preandmrna"]]) %>% as_tibble() %>% 
      filter(gene_name %in% singler_marker_genes_1) %>% pull(gene_id)
    singler_marker_genes_2 = rowData(sce_ls[["preandmrna"]]) %>% as_tibble() %>% 
      filter(gene_name %in% singler_marker_genes_2) %>% pull(gene_id)
  } else {
    singler_marker_genes_1 = celltype_markers_length_tb %>%
      filter(cell_type %in% c("Neurons")) %>% # need to change this for different cell types
      pull(gene)
    singler_marker_genes_2 = celltype_markers_length_tb %>%
      filter(cell_type %in% c("Endothelial cells")) %>% # need to change this for different cell types ("Astrocytes" or "Endothelial cells")
      pull(gene)
  }
  
  res = res %>%
    mutate(is_marker_gene = ifelse((gene %in% singler_marker_genes_1 &
                                      gene %in% singler_marker_genes_2), "Both",
                                   ifelse((gene %in% singler_marker_genes_1), "Neurons", 
                                          ifelse((gene %in% singler_marker_genes_2), "Endothelial", "None"))),
           is_differential_gene = padj < 0.05)
  return(res)
}

res_1 = label_res(res_1, pairwise = T)
res_2 = label_res(res_2, pairwise = T)
res_3 = label_res(res_3, pairwise = T)
res_4 = label_res(res_4, pairwise = T)
```


```{r}
res = res_1
# Length vs log2fold change
p = res %>%
  ggplot(aes(x = transcript_length, y = log2FoldChange)) + 
  geom_point(aes(color = padj < 0.05), alpha = 0.05) +
  geom_smooth() +
  scale_x_log10() +
  labs(x = "Transcript length") +
  theme_bw()
print(p)
# saveRDS(p, here(paste0("./mouse_cortex/plots/de_length_bias_", pipeline, "_ie.rds")))

# Density histograms for all genes (orange) vs differential genes (blue)
p = res %>%
  ggplot(aes(x = transcript_length, y = ..density..)) +
  geom_histogram(fill = "#E69F00", alpha = 0.5) +
  geom_histogram(data = res %>% filter(padj < 0.05), aes(x = transcript_length, y = ..density..), fill = "#56B4E9", alpha = 0.5) +
  scale_x_log10() +
  labs(x = "Transcript length", y = "Density") +
  theme_bw()
print(p)
# saveRDS(p, here(paste0("./mouse_cortex/plots/de_length_bias_dens_", pipeline, "_ie.rds")))

# Compare overlap between differential genes and singleR marker genes
# res_1 %>%
#   ggplot(aes(x = is_differential_gene)) + 
#   facet_wrap(~ is_marker_gene, scales = "free_y", labeller = label_both) +
#   geom_bar() +
#   labs(title = "Pairwise marker genes only") +
#   theme_bw() +
#   theme(legend.position = "top")
# 
# res_1 %>%
#   right_join(., res_2, by = "gene") %>%
#   ggplot(aes(x = is_differential_gene.y, fill = is_differential_gene.x)) + 
#   facet_wrap(~ is_marker_gene.y, scales = "free_y", labeller = label_both) +
#   geom_bar() +
#   labs(title = "Pairwise marker genes only") +
#   theme_bw() +
#   theme(legend.position = "top")
# 
# res_1 %>%
#   right_join(., res_2, by = "gene") %>%
#   ggplot(aes(x = length.x, color = is_differential_gene.y)) +
#   geom_density() +
#   scale_x_log10() +
#   facet_wrap(~ is_marker_gene.y, scales = "free_y", labeller = label_both) +
#   labs(title = "Pairwise marker genes only") +
#   theme_bw() +
#   theme(legend.position = "top")
```


```{r}
# Tables
library(janitor)
## Differential genes
res_3 %>% tabyl(is_differential_gene, is_marker_gene) %>% 
    adorn_totals(c("row", "col")) %>%
    adorn_percentages("row") %>%
    adorn_pct_formatting(digits = 2) %>%
    adorn_ns

## Top 1000 genes
res_3 %>% 
  arrange(padj) %>%
  mutate(is_top1p_gene = row_number() <= 1000) %>%
  tabyl(is_top1p_gene, is_marker_gene) %>% 
    adorn_totals(c("row", "col")) %>%
    adorn_percentages("row") %>%
    adorn_pct_formatting(digits = 2) %>%
    adorn_ns
```

```{r}
## Top n differential versus proportion of marker genes recovered (maximize biological signal)
get_prop = function(res, label_normalization){
  res = res %>%
    arrange(padj) %>%
    mutate(n_marker_genes_1 = cumsum(is_marker_gene == "Endothelial"),
           n_marker_genes_2 = cumsum(is_marker_gene == "Neurons"),
           n = row_number(),
           prop_marker_genes_1 = n_marker_genes_1/n,
           prop_marker_genes_2 = n_marker_genes_2/n,
           prop_marker_genes_all = (n_marker_genes_1 + n_marker_genes_2)/(2*n),
           label = label_normalization) %>%
    select(gene, padj, n, prop_marker_genes_1, prop_marker_genes_2, prop_marker_genes_all, label) %>%
    pivot_longer(cols = starts_with("prop_marker_genes"),
                 names_to = "marker_genes_celltype",
                 values_to = "proportion")
}

# res_prop_1 = get_prop(res_1, label_normalization = "None")
# res_prop_2 = get_prop(res_2, label_normalization = "cQN only")
# res_prop_3 = get_prop(res_3, label_normalization = "downsampling and cQN")
# res_prop = bind_rows(res_prop_1, res_prop_2, res_prop_3)

res_prop_1 = get_prop(res_1, label_normalization = "transcripts")
res_prop_2 = get_prop(res_2, label_normalization = "preandmrna")
res_prop_3 = get_prop(res_3, label_normalization = "introncollapse")
res_prop_4 = get_prop(res_4, label_normalization = "intronseparate")
res_prop = bind_rows(res_prop_1, res_prop_2, res_prop_3, res_prop_4)

res_prop %>%
  ggplot(aes(x = n, y = proportion, color = label)) + 
  geom_line() +
  # geom_point() + 
  facet_wrap(~ marker_genes_celltype, nrow = 3, scales = "free_y") +
  xlim(c(0, 2000)) +
  theme_bw() 
  
```

```{r}
pipeline = "preandmrna"
res_no_cqn = readRDS(here(paste0("./mouse_cortex/output/de_ie_", pipeline, "_lfc.rds")))
res_with_cqn = readRDS(here(paste0("./mouse_cortex/output/de_ie_", pipeline, "_lfc_cqn_bc.rds")))

res_no_cqn_ranked = res_no_cqn %>%
  arrange(padj) %>%
  mutate(rank_no_cqn = 1:n(),
         padj_no_cqn = padj) %>%
  select(gene, padj_no_cqn, rank_no_cqn, length)

res_with_cqn_ranked = res_with_cqn %>%
  arrange(padj) %>%
  mutate(rank_with_cqn = 1:n(),
         padj_with_cqn = padj) %>%
  select(gene, padj_with_cqn, rank_with_cqn)

res_combined = res_no_cqn_ranked %>%
  inner_join(., res_with_cqn_ranked, by = "gene")

res_combined %>%
  filter(!is.na(padj_no_cqn) & !is.na(padj_with_cqn)) %>%
  # filter(padj_no_cqn < 0.05) %>%
  mutate(length_label = ifelse(length > quantile(length, 0.9), "> 90th percentile", NA),
         length_label = ifelse(length < quantile(length, 0.1), "< 10th percentile", length_label),
         significant_both = (padj_no_cqn < 0.05) & (padj_with_cqn < 0.05)) %>%
  filter(!is.na(length_label)) %>%
  ggplot(aes(x = rank_no_cqn, y = rank_with_cqn, color = significant_both)) + 
  facet_wrap(~ length_label, nrow = 1, labeller = label_both) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point(alpha = 0.5) + 
  theme_bw()
```


```{r}
# # Length vs pvalue
# res %>%
#   filter(!is.na(preandmrna)) %>%
#   ggplot(aes(x = length, y = pvalue)) + 
#   geom_point(alpha = 0.05) +
#   geom_smooth() +
#   scale_x_log10() +
#   scale_y_continuous(limits = c(0, 1)) +
#   theme_bw()
# 
# # Length vs padj
# res %>%
#   filter(!is.na(preandmrna)) %>%
#   ggplot(aes(x = length, y = padj)) + 
#   geom_point(alpha = 0.05) +
#   geom_smooth() +
#   scale_x_log10() +
#   scale_y_continuous(limits = c(0, 1)) +
#   theme_bw()
# 
# # Expression vs log2fold change
# res %>%
#   filter(!is.na(preandmrna)) %>%
#   ggplot(aes(x = preandmrna, y = log2FoldChange)) + 
#   geom_point(alpha = 0.05) +
#   geom_smooth() +
#   scale_x_log10(limits = c(0.1, 1e7)) +
#   theme_bw()
# 
# # Mean exp vs pvalue
# res %>%
#   filter(!is.na(preandmrna)) %>%
#   ggplot(aes(x = preandmrna, y = pvalue)) + 
#   geom_point(alpha = 0.05) +
#   geom_smooth() +
#   scale_x_log10(limits = c(0.1, 1e7)) +
#   scale_y_continuous(limits = c(0, 1)) +
#   theme_bw()
# 
# # Mean exp vs padj
# res %>%
#   filter(!is.na(preandmrna)) %>%
#   ggplot(aes(x = preandmrna, y = padj)) + 
#   geom_point(alpha = 0.05) +
#   geom_smooth() +
#   scale_x_log10(limits = c(0.1, 1e7)) +
#   scale_y_continuous(limits = c(0, 1)) +
#   theme_bw()
```

### DE analysis (human samples)

Download data from https://github.com/LieberInstitute/10xPilot_snRNAseq-human 

```{r}
load(here("mouse_cortex", "data", "SCE_AMY-n5_tran-etal.rda"))
load(here("mouse_cortex", "data", "SCE_DLPFC-n3_tran-etal.rda"))
# load(here("mouse_cortex", "data", "SCE_HPC-n3_tran-etal.rda"))
# load(here("mouse_cortex", "data", "SCE_NAc-n8_tran-etal.rda"))
# load(here("mouse_cortex", "data", "SCE_sACC-n5_tran-etal.rda"))
sce = sce.dlpfc.tran
``` 

```{r}
table(colData(sce)$donor)
table(colData(sce)$cellType)
table(colData(sce)$cellType, colData(sce)$donor)
```

#### Gene length bias

```{r}
# Read in gene lengths (run on cluster with get-gc-content.R)
gc_content_human = readRDS(here("./mouse_cortex/output/gc_content_human.rds"))
gc_content_human = gc_content_human %>% 
  as_tibble(rownames = "gene") %>% 
  dplyr::rename(length_biomart = length)

rowData(sce) = rowData(sce) %>%
  as.data.frame() %>%
  left_join(., gc_content_human, by = c("gene_id" = "gene"))
```

```{r}
# Get rowmeans for every cell type and sample
tmp_tb_ls = list()
cell_types = names(table(colData(sce)$cellType)[table(colData(sce)$cellType) > 500])
samples = unique(colData(sce)$donor)
cdata = colData(sce) %>% as.data.frame()

for(cell_type in cell_types){
  print(cell_type)
  cells_ct = cdata %>%
    filter(cellType == cell_type) %>%
    rownames()
  
  for(s in samples){
    sample_cells = cdata %>%
      filter(donor == s) %>%
      rownames()
    
    cells = intersect(cells_ct, sample_cells)
    if(length(cells) < 50) next
    
    m = counts(sce[, cells]) 
    genes_rowmeans = rowMeans(m)
    tmp_tb_ls[[paste(cell_type, s)]] = tibble(gene = names(genes_rowmeans),
                                              gene_id = rowData(sce)$gene_id,
                                              mean_expression = genes_rowmeans,
                                              cell_type = cell_type,
                                              sample = s,
                                              length_biomart = rowData(sce)$length_biomart,
                                              gc = rowData(sce)$gc)
  }
}

genes_rowmeans_human_tb = bind_rows(tmp_tb_ls)
```

```{r}
# Plot gene length bias by sample
genes_rowmeans_human_tb %>%
  # filter(mean_expression > 0) %>%
  # filter(preandmrna_max_nA == 0) %>%
  # filter(cell_type %in% c("Inhib_D")) %>%
  # filter(sample %in% c("donor4", "donor5")) %>%
  # filter(cortex == "cortex2") %>%
  ggplot(aes(x = length_biomart, y = mean_expression, color = sample)) +
  facet_wrap(cell_type ~ .) +
  # geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  labs(x = "Gene length", y = "Mean expression", color = "Sample") +
  theme_bw()

# Plot GC bias by sample
genes_rowmeans_human_tb %>%
  # filter(mean_expression > 0) %>%
  # filter(preandmrna_max_nA == 0) %>%
  # filter(cell_type %in% c("Inhib_D")) %>%
  # filter(sample %in% c("donor4", "donor5")) %>%
  # filter(cortex == "cortex2") %>%
  ggplot(aes(x = gc, y = mean_expression, color = sample)) +
  facet_wrap(cell_type ~ .) +
  # geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  labs(x = "GC content", y = "Mean expression", color = "Sample") +
  theme_bw()
```

```{r}
# Plot gene length bias by sample
genes_rowmeans_human_tb %>%
  # filter(mean_expression > 0) %>%
  # filter(preandmrna_max_nA == 0) %>%
  filter(cell_type %in% c("Oligo")) %>%
  filter(sample %in% c("donor1", "donor2")) %>%
  # filter(cortex == "cortex2") %>%
  ggplot(aes(x = length_biomart, y = mean_expression, color = sample)) +
  facet_wrap(cell_type ~ .) +
  geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  labs(x = "Gene length", y = "Mean expression", color = "Sample") +
  theme_bw()

# Plot GC bias by sample
genes_rowmeans_human_tb %>%
  # filter(mean_expression > 0) %>%
  # filter(preandmrna_max_nA == 0) %>%
  filter(cell_type %in% c("Oligo")) %>%
  filter(sample %in% c("donor1", "donor2")) %>%
  # filter(cortex == "cortex2") %>%
  ggplot(aes(x = gc, y = mean_expression, color = sample)) +
  facet_wrap(cell_type ~ .) +
  geom_point(alpha = 0.01) +
  geom_smooth() + 
  scale_x_log10() +
  scale_y_log10() +
  # scale_y_continuous(limits = c(0, 10)) +
  labs(x = "GC content", y = "Mean expression", color = "Sample") +
  theme_bw()
```

```{r}
genes_rowmeans_human_tb %>%
  filter(cell_type %in% c("Inhib_D")) %>%
  filter(sample %in% c("donor4", "donor5")) %>%
  arrange(-length_biomart)
```
#### cQN & DESeq

```{r}
abb = "donor1-2_Oligo"
res_1 = readRDS(here(paste0("./mouse_cortex/output/de_", abb, "_human_lfc.rds")))
res_2 = readRDS(here(paste0("./mouse_cortex/output/de_", abb, "_human_lfc_cqn.rds")))

res = res_2
# Length vs log2fold change
p = res %>%
  # filter(!is.na(padj)) %>%
  ggplot(aes(x = length_biomart, y = log2FoldChange)) + 
  geom_point(aes(color = padj < 0.05), alpha = 0.3) +
  geom_smooth() +
  scale_x_log10() +
  # ylim(c(-5, 5)) +
  labs(x = "Gene length",
       y = "log2FoldChange") +
  theme_bw()
print(p)

# GC content vs log2fold change
p = res %>%
  # filter(!is.na(padj)) %>%
  ggplot(aes(x = gc, y = log2FoldChange)) + 
  geom_point(aes(color = padj < 0.05), alpha = 0.3) +
  geom_smooth() +
  scale_x_log10() +
  # ylim(c(-5, 5)) +
  labs(x = "GC content",
       y = "log2FoldChange") +
  theme_bw()
print(p)

# Density histograms for all genes (orange) vs differential genes (blue)
p = res %>%
  ggplot(aes(x = length_biomart, y = ..density..)) +
  geom_histogram(fill = "#E69F00", alpha = 0.5) +
  geom_histogram(data = res %>% filter(padj < 0.05), aes(x = length_biomart, y = ..density..), fill = "#56B4E9", alpha = 0.5) +
  scale_x_log10() +
  labs(x = "Gene length", y = "Density") +
  theme_bw()
print(p)
```

```{r}
# Try to recreate DESeq2's log2FoldChange
seq_data = readRDS(here(paste0("./mouse_cortex/output/counts_donor4-5_Inhib_D_human_cqn.rds")))
counts(seq_data["ENSG00000269821", ])
tmp = counts(seq_data["ENSG00000269821", ])/colSums(counts(seq_data))
log2(mean(tmp[3:4]))-log2(mean(tmp[1:2]))
mean(log2(tmp[3:4]))-mean(log2(tmp[1:2]))

res_1 %>%
  filter(gene == "ENSG00000269821")
```

### Distributions

To assess distributions, we want to obtain a homogenous group of cells.

```{r}
source(here("./mouse_cortex/code/distribution-plots-helpers.R"))
```


```{r}
pipeline = "preandmrna"
sce = sce_ls[[pipeline]]

# Subset to cell type
cell_type = "Excitatory neuron"
sce_sub = sce[, colData(sce)$ding_labels == cell_type & !is.na(colData(sce)$ding_labels)]
dim(sce_sub)

# Subset to cortex
sce_sub = sce_sub[, colData(sce_sub)$cortex == "cortex1"]
dim(sce_sub)
```

#### Within-group clustering

Rerun PCA within cell type subgroup.

```{r}
# Normalize and take log
# clust = quickCluster(sce_sub)
# sce_sub = computeSumFactors(sce_sub, clusters = clust)
# sce_sub = logNormCounts(sce_sub)

set.seed(1)
tic("approx PCA")
sce_sub = runPCA(sce_sub, exprs_values = "logcounts", ntop = ncol(sce), BSPARAM = RandomParam())
toc()
```

```{r}
# colData(sce_sub)$cortex_flow_cell = paste(colData(sce_sub)$cortex,
#                                          colData(sce_sub)$flow_cell, sep = "_")
colData(sce_sub)$log_lib_size = log(colData(sce_sub)$lib_size)
plotReducedDim(sce_sub, "PCA", colour_by = "cortex", ncomponents = c(1, 2))
```

```{r eval = F}
# K-means clustering
set.seed(1)

# Elbow plot with SSE
sse = c()
for(k in 1:10){
  clust.kmeans <- kmeans(reducedDim(sce_sub, "PCA"), centers = k)
  sse = c(sse, clust.kmeans$tot.withinss)
}
plot(sse)

clust.kmeans <- kmeans(reducedDim(sce_sub, "PCA"), centers = 4)
colData(sce_sub)$labels_kmeans <- factor(clust.kmeans$cluster)
p = plotReducedDim(sce_sub, "PCA", colour_by = "labels_kmeans", ncomponents = c(1, 2))
saveRDS(p, here("./mouse_cortex/plots/pca_kmeans_preandmnra_inhibitory_neuron_cortex_1.rds"))
```

```{r eval = F}
# Graph-based clustering
g <- buildSNNGraph(sce_sub, k=10, use.dimred = 'PCA')
clust <- igraph::cluster_walktrap(g)$membership

colData(sce_sub)$labels_gb <- factor(clust)
plotReducedDim(sce_sub, "PCA", colour_by="labels_gb")
```

```{r}
# Use findMarkers (t-test) to identify candidate markers for clusters
markers = findMarkers(sce_sub, groups = colData(sce_sub)$labels_kmeans)

chosen = "1" # cluster chosen
interesting = markers[[chosen]]
best.set <- interesting[interesting$Top <= 6,]
logFCs <- getMarkerEffects(best.set)

library(pheatmap)
pheatmap(logFCs, breaks=seq(-5, 5, length.out=101))
```


#### Downsampling/proportion of zero plots

First, I make all the column sums comparable by downsampling (this is a stochastic transformation as opposed to scaling).

```{r}
# Subset to cluster
i = 4
counts_sub_cluster = counts(sce_sub)
# counts_sub_cluster = counts(sce_sub)[, colData(sce_sub)$labels_kmeans == i] # Subset to k-means cluster
# group into 3 groups by colSums
# terciles = quantile(colSums(counts_sub_cluster), c(1/3, 2/3))
# terciles
# summary(colSums(counts_sub_cluster))
# counts_sub_cluster = counts_sub_cluster[, (colSums(counts_sub_cluster) > terciles[2])]


# Downsample matrix
tic()
set.seed(1)
counts_sub_cluster_scaled = Down_Sample_Matrix(ceiling(counts_sub_cluster))
toc()
# counts_sub_cluster_scaled = counts_sub_cluster
counts_sub_cluster_scaled = counts_sub_cluster_scaled[rowSums(counts_sub_cluster_scaled) != 0, ]
summary(colSums(counts_sub_cluster_scaled))

# Save mean and size factor ratios to generate a Poisson sim
# saveRDS(list(means = rowMeans(counts_sub_cluster_scaled),
#              size_factors_ratios = colSums(counts_sub_cluster)/colSums(counts_sub_cluster_scaled)),
#         here("./mouse_cortex/output/emp_values_pois.rds"))

# Save values for simulation datasets
# nb_size = function(x){
#   estimates = suppressWarnings(fitdistr(x, "negative binomial")$estimate)
#   return(estimates['size'])
# }
# emp_values = list(means = apply(counts_sub_cluster_scaled, 1, mean),
#                   sizes = apply(counts_sub_cluster_scaled, 1, nb_size))
# saveRDS(emp_values, here("./mouse_cortex/output/emp_values.rds"))

# edgeR estimates (note that you do not need to downsample to do chi-squared tests)
# emp_values = list(means = apply(counts_sub_cluster, 1, mean),
#                   sizes = 1/edgeR::estimateDisp(counts_sub_cluster)$tagwise.dispersion)
# saveRDS(emp_values, here("./mouse_cortex/output/emp_values_edger_nodownsample.rds"))
```

I compute the average expression for every row (x-axis) $\hat{\mu}_i$ and the empirical $P(X_i=0)$, which is the probability that for a given transcript $i$, the count is 0. 

I then compute what $P(X_i=0)$ would be under the model assumptions of binomial or poisson, using parameters estimated from the data. In particular, for a $Binom(n, p_i)$, $n$ is the median number of total counts of cells and $p_i$ is the proportion of counts that were in gene $i$.

Generate and save for all combinations by running `distribution_plots.R`.

```{r}
# Plot P(X_i = 0) against average expression level
prob_out = plot_prob(counts_sub_cluster_scaled)
p = prob_out$plot +
  labs(title = paste(cell_type, i, sep = " - "))
print(p)
saveRDS(p, file = here(paste0("./mouse_cortex/plots/prob0_plot_preandmrna_inhibitory_neuron_cortex_1_cluster_", i, ".rds")))
```

#### Mean-variance plots

To generate these plots for all combinations, run `distribution-plots.R`.


```{r}
# Empirical mean and variance
mean_emp = rowMeans(counts_sub_cluster_scaled)
var_emp = genefilter::rowVars(counts_sub_cluster_scaled)

# Binomial
n = round(median(colSums(counts_sub_cluster_scaled)))
emp_props = rowSums(counts_sub_cluster_scaled)/sum(colSums(counts_sub_cluster_scaled))
var_binom = n*emp_props*(1-emp_props)

# Poisson
fit_pois = glmGamPoi::glm_gp(counts_sub_cluster_scaled, design = ~ 1, size_factors = FALSE, 
                             overdispersion = FALSE)
# Negative binomial
# Estimate overall size/dispersion parameter
model = lm(var_emp ~ 1*mean_emp + I(mean_emp^2) + 0, tibble(mean_emp, var_emp))
phi = 1/coef(model)["I(mean_emp^2)"]

# Estimate size/dispersion parameter for every gene
# library(glmGamPoi)
# fit_nb =  glmGamPoi::glm_gp(counts_sub_cluster_scaled, design = ~ 1, size_factors = FALSE, 
#                          overdispersion = TRUE)

# Note: rowMean(fit_pois$Mu) = rowMeans(fit_nb$Mu) = rowMeans(counts)
mean_var_tb = tibble(mean_emp = mean_emp,
                     var_emp = var_emp,
                     binomial = var_binom,
                     poisson = rowMeans(counts_sub_cluster_scaled),
                     nbinomial = mean_emp + mean_emp^2 * 1/phi) %>%
  # var_nb_v2 = mean_emp + mean_emp^2 * fit_nb$overdispersions) %>% 
  tidyr::pivot_longer(cols = -mean_emp, names_to = "model", values_to = "var_value")

# Plot
p = mean_var_tb %>%
  filter(model %in% c("var_emp")) %>%
  ggplot(aes(x = mean_emp, y = var_value)) + 
  geom_point(alpha = 0.3) + 
  geom_line(data = mean_var_tb %>% filter(model %in% c("binomial", "poisson", "nbinomial")),
            aes(x = mean_emp, y = var_value, color = model)) +
  scale_x_log10() + scale_y_log10() +
  labs(title = pipeline,
       subtitle = paste(cell_type, cortex, sep = " - "),
       x = "Log of mean expression",
       y = "Log of variance") +
  theme_bw()
```

#### Goodness-of-fit tests

##### By Count Values

There are 2 issues:

1) Why is quant matrix not all integers?
2) Why are NaNs produced/non-finite finite-difference value errors occur in fitdistr("negative binomial")?

```{r eval = F}
library(MASS)

# Poisson
p_values_pois = p_chisq_test(counts_sub_cluster_scaled, distribution = "poisson")
plot_dt = tibble(p_value = p_values_pois[[1]],
                 expression = rowSums(counts_sub_cluster_scaled))

plot_dt %>%
  # filter(expression > 50) %>%
  ggplot(aes(x = p_value)) + 
  geom_histogram() +
  theme_bw()

plot_dt %>%
  # filter(expression > 50) %>%
  ggplot(aes(x = p_value, y = expression)) + 
  geom_point(size = 0.1, alpha = 0.1) +
  geom_smooth() +
  scale_y_log10() +
  theme_bw()
```

```{r}
# Negative binomial
p_values_nb = p_chisq_test(counts_sub_cluster_scaled, distribution = "nb")
plot_dt = tibble(p_value = p_values_nb[[1]],
                 expression = rowSums(counts_sub_cluster_scaled)[setdiff(1:nrow(counts_sub_cluster_scaled), p_values_nb[[2]])])

plot_dt %>%
  # filter(expression > 50) %>%
  ggplot(aes(x = p_value)) + 
  geom_histogram() +
  theme_bw()

plot_dt %>%
  # filter(expression > 50) %>%
  ggplot(aes(x = p_value, y = expression)) + 
  geom_point(size = 0.1, alpha = 0.1) +
  geom_smooth() +
  scale_y_log10() +
  theme_bw()
```

##### By Sample

This is based on Figure 2 from this paper: https://genome.cshlp.org/content/18/9/1509.full.html 

```{r}
# Poisson
chi_obs_pois = p_chisq_test_2(counts_sub_cluster_scaled, distribution = "poisson")
plot_dt = tibble(chi_obs = chi_obs_pois,
                 expression = rowSums(counts_sub_cluster_scaled)) %>%
  arrange(chi_obs) %>%
  drop_na() %>%
  mutate(chi_quantile = qchisq(p = (1:length(chi_obs))/length(chi_obs), df = ncol(counts_sub_cluster_scaled) - 1),
         percentile_color = case_when(chi_obs > quantile(chi_obs, 0.995) ~ "> 99.5",
                                      chi_obs > quantile(chi_obs, 0.95) ~ "> 95",
                                      chi_obs > quantile(chi_obs, 0.90) ~ "> 90",
                                      T ~ "rest"),
         i = i)

plot_dt %>%
  # filter(expression > 50) %>%
  ggplot(aes(x = chi_quantile,
             y = chi_obs,
             color = percentile_color)) + 
  geom_point(size = 0.5) + 
  geom_abline(slope = 1, intercept = 0) +
  # coord_cartesian(ylim = c(250, 1000)) +
  labs(x = "Chi-squared quantiles",
       y = "Goodness of fit statistic") +
  guides(color = FALSE) +
  theme_bw()
```


```{r}
# # Filter to protein coding genes
# protein_coding_genes = rowData(sce) %>% as_tibble() %>% filter(transcript_type == "protein_coding") %>% pull(gene_id)
# counts_sub_drop = counts_sub_cluster_scaled[rownames(counts_sub_cluster_scaled) %in% protein_coding_genes, ]
# # Filter to genes with rowMeans > median
# row_means = rowMeans(counts_sub_drop)
# counts_sub_drop = counts_sub_drop[row_means > mean(row_means), ]

# Poisson (grouped)
chi_obs_pois = p_chisq_test_2_grouped(counts_sub_cluster, distribution = "poisson")
plot_dt = tibble(chi_obs = chi_obs_pois[[1]]) %>%
                 # expression = rowSums(counts_sub_cluster_scaled)) %>%
  arrange(chi_obs) %>%
  drop_na() %>%
  mutate(chi_quantile = qchisq(p = (1:length(chi_obs))/length(chi_obs), df = chi_obs_pois[[2]] - 1),
         percentile_color = case_when(chi_obs > quantile(chi_obs, 0.995) ~ "> 99.5",
                                      chi_obs > quantile(chi_obs, 0.95) ~ "> 95",
                                      #chi_obs > quantile(chi_obs, 0.90) ~ "> 90",
                                      T ~ "rest"),
         i = i)

p = plot_dt %>%
    ggplot(aes(x = chi_quantile,
             y = chi_obs,
             color = percentile_color)) + 
  geom_point(size = 0.5) + 
  geom_abline(slope = 1, intercept = 0) +
  # coord_cartesian(ylim = c(0, 20)) +
  labs(x = "Chi-squared quantiles",
       y = "Goodness of fit statistic") +
  # guides(color = FALSE) +
  theme_bw()
print(p)
saveRDS(p, here(paste0("./mouse_cortex/plots/qq_plot_poisson_", pipeline, "_", snakecase::to_snake_case(cell_type), "_cortex_1.rds")))
```

```{r}
# Negative binomial (single overdispersion parameter)
chi_obs_nb = p_chisq_test_2(counts_sub_cluster_scaled, distribution = "nb 1")
plot_dt = tibble(chi_obs = chi_obs_nb) %>%
  arrange(chi_obs) %>%
  drop_na() %>%
  mutate(chi_quantile = qchisq(p = (1:length(chi_obs))/length(chi_obs), df = ncol(counts_sub_cluster_scaled) - 2),
         percentile_color = case_when(chi_obs > quantile(chi_obs, 0.995) ~ "> 99.5",
                                      chi_obs > quantile(chi_obs, 0.95) ~ "> 95",
                                      chi_obs > quantile(chi_obs, 0.90) ~ "> 90",
                                      T ~ "rest"),
         i = i)

plot_dt %>%
  # filter(expression > 50) %>%
    ggplot(aes(x = chi_quantile,
             y = chi_obs,
             color = percentile_color)) + 
  geom_point(size = 0.5) + 
  geom_abline(slope = 1, intercept = 0) +
  # coord_cartesian(ylim = c(250, 1000)) +
  theme_bw()
```

```{r}
# Negative binomial (single overdispersion parameter - grouped)
chi_obs_nb = p_chisq_test_2_grouped(counts_sub_cluster_scaled, distribution = "nb 1")
plot_dt = tibble(chi_obs = chi_obs_nb[[1]]) %>%
  # expression = rowSums(counts),
  # var = apply(counts, 1, var),
  # prop_0 = apply(counts, 1, function(x) sum(x == 0))) %>%
  mutate(id = 1:n()) %>%
  arrange(chi_obs) %>%
  drop_na() %>%
  mutate(chi_quantile = qchisq(p = (1:length(chi_obs))/length(chi_obs), df = chi_obs_nb[[2]] - 1),
         percentile_color = case_when(chi_obs > quantile(chi_obs, 0.995, na.rm = TRUE) ~ "> 99.5",
                                      chi_obs > quantile(chi_obs, 0.95, na.rm = TRUE) ~ "> 95",
                                      chi_obs > quantile(chi_obs, 0.90, na.rm = TRUE) ~ "> 90",
                                      T ~ "rest"),
         i = i)

plot_dt %>%
  # filter(expression > 50) %>%
    ggplot(aes(x = chi_quantile,
             y = chi_obs,
             color = percentile_color)) + 
  geom_point(size = 0.5) + 
  geom_abline(slope = 1, intercept = 0) +
  # coord_cartesian(ylim = c(250, 1000)) +
  theme_bw()
```


```{r}
# Negative binomial (gene-specific overdispersion parameter)
chi_obs_nb = p_chisq_test_2(counts_sub_cluster_scaled, distribution = "nb 2")
plot_dt = tibble(chi_obs = chi_obs_nb) %>%
  arrange(chi_obs) %>%
  drop_na() %>%
  mutate(chi_quantile = qchisq(p = (1:length(chi_obs))/length(chi_obs), df = ncol(counts_sub_cluster_scaled) - 1),
         percentile_color = case_when(chi_obs > quantile(chi_obs, 0.995) ~ "> 99.5",
                                      chi_obs > quantile(chi_obs, 0.95) ~ "> 95",
                                      chi_obs > quantile(chi_obs, 0.90) ~ "> 90",
                                      T ~ "rest"),
         i = i)

plot_dt %>%
  # filter(expression > 50) %>%
  ggplot(aes(x = chi_quantile,
             y = chi_obs,
             color = percentile_color)) + 
  geom_point(size = 0.5) + 
  geom_abline(slope = 1, intercept = 0) +
  # coord_cartesian(ylim = c(250, 1000)) +
  theme_bw()
```

```{r}
# Negative binomial (gene-specific overdispersion parameter - grouped)
chi_obs_nb = p_chisq_test_2_grouped(counts_sub_cluster_scaled, distribution = "nb 2")
plot_dt = tibble(chi_obs = chi_obs_nb[[1]]) %>%
  # expression = rowSums(counts),
  # var = apply(counts, 1, var),
  # prop_0 = apply(counts, 1, function(x) sum(x == 0))) %>%
  mutate(id = 1:n()) %>%
  arrange(chi_obs) %>%
  drop_na() %>%
  mutate(chi_quantile = qchisq(p = (1:length(chi_obs))/length(chi_obs), df = chi_obs_nb[[3]] - 2),
         percentile_color = case_when(chi_obs > quantile(chi_obs, 0.995, na.rm = TRUE) ~ "> 99.5",
                                      chi_obs > quantile(chi_obs, 0.95, na.rm = TRUE) ~ "> 95",
                                      chi_obs > quantile(chi_obs, 0.90, na.rm = TRUE) ~ "> 90",
                                      T ~ "rest"),
         i = i)

p = plot_dt %>%
  # filter(expression > 50) %>%
    ggplot(aes(x = chi_quantile,
             y = chi_obs,
             color = percentile_color)) + 
  geom_point(size = 0.5) + 
  geom_abline(slope = 1, intercept = 0) +
  # coord_cartesian(ylim = c(250, 1000)) +
  labs(x = "Chi-squared quantiles",
       y = "Goodness of fit statistic") +
  guides(color = FALSE) +
  theme_bw()
print(p)
saveRDS(p, here("./mouse_cortex/plots/qq_plot_nb_2_astrocyte_cortex_1.rds"))
```


##### Likelihood-Ratio

```{r}
library(tweeDEseq)
```

```{r}
x2_lr = gofTest(counts_sub_cluster_scaled, a = 1) # poisson

plot_dt = tibble(chi_obs = sort(x2_lr),
                 chi_quantile = qchisq(p = (1:length(sort(x2_lr)))/length(sort(x2_lr)),
                                       df = 1),
                 percentile_color = case_when(chi_obs > quantile(chi_obs, 0.995) ~ "> 99.5",
                                        chi_obs > quantile(chi_obs, 0.95) ~ "> 95",
                                        chi_obs > quantile(chi_obs, 0.90) ~ "> 90",
                                        T ~ "rest"))

plot_dt %>%
  ggplot(aes(x = chi_quantile,
             y = chi_obs,
             color = percentile_color)) + 
  geom_point(size = 0.5) + 
  geom_abline(slope = 1, intercept = 0) +
  # coord_cartesian(ylim = c(250, 1000)) +
  theme_bw()
```

```{r}
x2_lr = gofTest(counts_sub_cluster_scaled, a = 0) # negative binomial

plot_dt = tibble(chi_obs = sort(x2_lr),
                 chi_quantile = qchisq(p = (1:length(sort(x2_lr)))/length(sort(x2_lr)),
                                       df = 1),
                 percentile_color = case_when(chi_obs > quantile(chi_obs, 0.995) ~ "> 99.5",
                                        chi_obs > quantile(chi_obs, 0.95) ~ "> 95",
                                        chi_obs > quantile(chi_obs, 0.90) ~ "> 90",
                                        T ~ "rest"))

plot_dt %>%
  ggplot(aes(x = chi_quantile,
             y = chi_obs,
             color = percentile_color)) + 
  geom_point(size = 0.5) + 
  geom_abline(slope = 1, intercept = 0) +
  # coord_cartesian(ylim = c(250, 1000)) +
  theme_bw()
```


#### BIC log-likelihood

Source: https://github.com/willtownes/scrna2019/blob/028363f04139a58b19143f3058ca8fa4a3533b63/util/functions.R

```{r}
m = counts_sub_cluster_scaled
m = ceiling(m)
summary(colSums(m))
summary(rowSums(m))
m = m[rowSums(m) != 0, ]
dim(m)

mbic = mult_bic(m)
pbic = poi_bic(m)
nbbic1 = nb_bic_1(m)
nbbic2 = nb_bic_2(m)
```


```{r}
bic_tb = tibble(id = 1:nrow(m),
                multinomial = unlist(mbic),
                poisson = unlist(pbic),
                negative_binomial = unlist(nbbic1),
                negative_binomial_gs = unlist(nbbic2))

bic_tb %>%
  pivot_longer(-id) %>%
  ggplot(aes(x = name, y = -value)) + 
  geom_boxplot() + 
  # scale_y_log10() +
  labs(y = "Negative LL") 
```


```{r eval = F}
m = counts_sub_cluster_scaled
m = ceiling(m)
summary(colSums(m))
summary(rowSums(m))
m = m[rowSums(m) != 0, ]
dim(m)

bic_tb = tibble(multinomial = mult_bic(m),     # 5 sec
                # dmn = dmn_bic(m),     # Unknown time, need to run as script on cluster
                poisson = poi_bic(m),       # 5 sec
                negative_binomial_1 = nb_bic_1(m),     # 5 sec
                negative_binomial_2 = nb_bic_2(m),   # 15 min
                cell_type_name = cell_type)

# Plot
bic_tb %>% 
  pivot_longer(cols = -cell_type_name) %>%
  ggplot(aes(x = reorder(name, value), y = value)) +
  geom_point(size = 3) +
  labs(title = pipeline,
       x = "Distribution",
       y = "BIC") +
  theme_bw()
```

